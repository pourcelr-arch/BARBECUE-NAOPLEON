<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant BBQ Pro Napol√©on</title>

    <!-- M√©tadonn√©es pour l'application web -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Guide Pro BBQ">

    <!-- Ic√¥ne de l'application -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' fill='%232D3748' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='none'%3E%3C/rect%3E%3Cpath d='M208,104c0-44.2-35.8-80-80-80S48,59.8,48,104Z' opacity='0.2'%3E%3C/path%3E%3Cpath d='M216,104a88,88,0,0,1-176,0Z' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/path%3E%3Cline x1='40' y1='104' x2='216' y2='104' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cline x1='96' y1='104' x2='80' y2='224' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cline x1='160' y1='104' x2='176' y2='224' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cpath d='M80,224a56,56,0,0,0,96,0' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/path%3E%3C/svg%3E">

    <!-- Chargement de Tailwind CSS et Tone.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; color: #1a202c; line-height: 1.6; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .kettle-bg { background-color: #2D3748; border-radius: 1rem; color: white; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .action-button { transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .action-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .action-button:disabled { cursor: not-allowed; background-color: #9ca3af; }
        .wizard-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); margin-top: 2rem; }
        .wizard-title { font-size: 1.5rem; font-weight: 700; color: #1a202c; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
        .home-choice-card { text-align: center; padding: 2rem 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease-in-out; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .home-choice-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #c53030; }
        .nav-button { background-color: #4a5568; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        #timerDisplay { font-size: 2.5rem; font-weight: 700; color: #FBBF24; }
        .side-panel { position: fixed; top: 1rem; width: 350px; height: 80vh; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s ease-in-out; }
        .side-panel-left { left: 1rem; transform: translateX(-110%); }
        .side-panel-right { right: 1rem; transform: translateX(110%); }
        .side-panel.visible { transform: translateX(0); }
        .side-panel-content { height: calc(100% - 3rem); overflow-y: auto; padding: 1rem; font-size: 0.9rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; } .prose h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem; } .prose h3 { font-size: 1.1rem; font-weight: bold; margin-top: 0.75rem; } .prose strong { color: #c53030; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background-color 0.2s; } .list-item:hover { background-color: #f7fafc; }
    </style>
</head>
<body class="px-4 sm:px-8 pt-8 pb-8">

    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[300]">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-3 text-gray-800">Acc√®s s√©curis√©</h3>
            <p class="mb-4 text-gray-700">Veuillez entrer le code d'acc√®s.</p>
            <input type="password" id="passwordInput" class="border p-2 w-full rounded mb-4">
            <button onclick="checkPassword()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full">Entrer</button>
            <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Code incorrect.</p>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-4xl mx-auto">
        <header class="text-center mb-6 relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">Assistant Pro : <span class="text-red-700">BBQ Napol√©on PRO22K-LEG-3</span></h1>
            <p class="text-lg text-gray-600">Votre planification de cuisson parfaite commence ici.</p>
        </header>

        <!-- NAVIGATION WIZARD -->
        <div id="wizard">
            <!-- √âCRAN 1: ACCUEIL -->
            <div id="screen-home" class="screen active">
                <div class="wizard-card text-center">
                    <h2 class="wizard-title">Comment voulez-vous commencer ?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="home-choice-card" onclick="startFlow('mealTime')">
                            <div>
                                <div class="text-5xl mb-4">üóìÔ∏è</div>
                                <h3 class="font-bold text-xl mb-2">Je choisis mon heure de repas</h3>
                            </div>
                            <p class="text-gray-600">L'assistant calcule pour vous l'heure de d√©marrage et g√©n√®re un planning complet.</p>
                        </div>
                        <div class="home-choice-card" onclick="startFlow('prepareNow')">
                            <div>
                                <div class="text-5xl mb-4">üî•</div>
                                <h3 class="font-bold text-xl mb-2">Je pr√©pare mon BBQ maintenant</h3>
                            </div>
                            <p class="text-gray-600">Lancez un guide pas-√†-pas ou une timeline pour une cuisson qui d√©marre tout de suite.</p>
                        </div>
                        <div class="home-choice-card" onclick="startFlow('readyNow')">
                            <div>
                                <div class="text-5xl mb-4">‚úÖ</div>
                                <h3 class="font-bold text-xl mb-2">Mon BBQ est d√©j√† pr√™t</h3>
                            </div>
                            <p class="text-gray-600">Indiquez ce qui est sur la grille et obtenez des instructions adapt√©es.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 2: HEURE DU REPAS -->
            <div id="screen-meal-time" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üóìÔ∏è √Ä quelle heure souhaitez-vous manger ?</h2>
                    <input type="time" id="mealTimeInput" class="border p-3 text-2xl w-full rounded-lg text-center">
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setMealTime()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Suivant</button>
                    </div>
                </div>
            </div>
            
            <!-- √âCRAN 3: M√âTHODE DE CUISSON -->
            <div id="screen-method" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üî• Quelle technique de cuisson ?</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onclick="setCookingMethod('grill')" class="action-button bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Cuisson / Grill</button>
                        <button onclick="setCookingMethod('smoke')" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Fumage</button>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                    </div>
                </div>
            </div>
            
            <!-- √âCRAN 4: MODE DE CUISSON -->
            <div id="screen-cooking-mode" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">‚öôÔ∏è Mode de cuisson</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onclick="setCookingMode('single')" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Un seul aliment</button>
                        <button onclick="setCookingMode('multiple')" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Plusieurs aliments (l'un apr√®s l'autre)</button>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 5: S√âLECTION DES ALIMENTS -->
            <div id="screen-food-selection" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üçñ Que voulez-vous cuisiner ?</h2>
                    <input type="text" id="foodSearchInput" onkeyup="filterAndSearchFoods()" class="border p-2 w-full rounded my-4" placeholder="Rechercher un plat, une viande, un l√©gume...">
                    <div id="food-options-container" class="space-y-3 mb-6 max-h-[50vh] overflow-y-auto pr-2"></div>
                    <div id="generateFoodContainer" class="hidden text-center my-4">
                        <p id="generateFoodText" class="mb-3">Aucun r√©sultat. Voulez-vous g√©n√©rer un guide ?</p>
                        <button id="generateFoodBtn" onclick="triggerGenerateCustomFoodGuide()" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">G√©n√©rer avec Gemini</button>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setFoods()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Suivant</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 6: COMBUSTIBLE -->
            <div id="screen-fuel" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">ü™µ Choix du Combustible</h2>
                    <div id="fuel-recommendation" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-2">Type de combustible :</h3>
                            <select id="fuel-type-select" class="border p-2 w-full rounded"></select>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2">Bois de fumage :</h3>
                            <select id="fuel-wood-select" class="border p-2 w-full rounded"></select>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setFuelAndGeneratePlan()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">G√©n√©rer le Planning</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 7: R√âSUM√â DU PLANNING -->
            <div id="screen-planning-summary" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üìã Votre Plan de Cuisson</h2>
                    <div id="summary-content" class="space-y-4"></div>
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="startCooking()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">D√©marrer la Cuisson !</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION CUISSON ACTIVE -->
        <div id="cooking-timeline-section" class="hidden">
            <div class="kettle-bg mb-6">
                <h2 class="text-2xl font-bold mb-4">Suivi de la Cuisson</h2>
                <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg">
                    <div class="text-center mb-4 sm:mb-0">
                        <p class="text-gray-400">Minuteur de l'√©tape :</p>
                        <div id="timerDisplay">00:00</div>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">√âtape en cours :</p>
                        <p id="currentStep" class="text-xl font-semibold text-yellow-400">EN ATTENTE</p>
                    </div>
                </div>
            </div>
            <div id="timeline-container" class="space-y-2"></div>
            <button onclick="resetApp()" class="action-button w-full mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                Terminer & R√©initialiser la Session
            </button>
        </div>

        <!-- Boutons flottants -->
        <div class="fixed top-4 left-4 z-[101] flex flex-col gap-2">
            <button id="saucesToggle" onclick="togglePanel('saucesPanel')" class="action-button bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-full shadow-lg" aria-label="Sauces et Marinades">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3.1_8a5.87 5.87 0 0 1 7.17 3.01A6 6 0 0 1 10 18a6 6 0 0 1-6-6c0-1.74.78-3.32 2-4.42Z"/><path d="m14 4 1-1 1 1"/><path d="M12 22a2 2 0 0 0 2-2v-2H10v2a2 2 0 0 0 2 2Z"/></svg>
            </button>
            <button id="notebookToggle" onclick="togglePanel('notebookPanel')" class="action-button bg-blue-600 text-white p-3 rounded-full shadow-lg" aria-label="Mon Carnet">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6h4"/><path d="M2 12h4"/><path d="M2 18h4"/><path d="M6 4v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2z"/></svg>
            </button>
        </div>
        <div class="fixed top-4 right-4 z-[101]">
            <button id="referenceToggle" onclick="togglePanel('referenceGuide')" class="action-button bg-gray-800 text-white p-3 rounded-full shadow-lg" aria-label="Aide-m√©moire">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </button>
        </div>

        <!-- Panneaux Lat√©raux -->
        <div id="saucesPanel" class="side-panel side-panel-left">
            <div class="flex items-center p-2 bg-gray-100 border-b">
                <button id="saucesBackButton" onclick="goBackSauces()" class="hidden p-1 mr-2 text-blue-600 hover:bg-gray-200 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </button>
                <h3 id="saucesTitle" class="font-bold flex-1">Sauces & Marinades</h3>
                <button onclick="togglePanel('saucesPanel')" class="p-1">&times;</button>
            </div>
            <div id="saucesPanelContent" class="side-panel-content"></div>
        </div>
        <div id="referenceGuide" class="side-panel side-panel-right">
            <div class="flex justify-between items-center p-2 bg-gray-100 border-b"><h3 class="font-bold">Aide-M√©moire</h3><button onclick="togglePanel('referenceGuide')" class="p-1">&times;</button></div>
            <div id="referenceGuideContent" class="side-panel-content"></div>
        </div>
        <div id="notebookPanel" class="side-panel side-panel-left">
            <div class="flex justify-between items-center p-2 bg-gray-100 border-b"><h3 class="font-bold">Mon Carnet de Recettes</h3><button onclick="togglePanel('notebookPanel')" class="p-1">&times;</button></div>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button onclick="showNotebookTab('favorites')" id="tab-favorites" class="w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm text-blue-600 border-blue-600">Favoris</button>
                    <button onclick="showNotebookTab('history')" id="tab-history" class="w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Historique</button>
                </nav>
            </div>
            <div id="notebookContentFavorites" class="side-panel-content"></div>
            <div id="notebookContentHistory" class="side-panel-content hidden"></div>
        </div>

        <!-- Modales -->
        <div id="customFoodModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full text-left transform transition-all scale-95 opacity-0" id="customFoodModalBox">
                <h3 id="customFoodModalTitle" class="text-xl font-bold text-gray-800 mb-3">Ajouter un aliment personnalis√©</h3>
                <p id="customFoodModalText" class="text-gray-600 mb-4">Quel aliment souhaitez-vous cuire ?</p>
                <input type="text" id="customFoodInput" class="border p-2 w-full rounded mt-2 mb-4" placeholder="Ex: C√¥te de porc √©paisse">
                <div id="customFoodLoader" class="hidden text-center my-4">
                    <p>Gemini pr√©pare votre guide de cuisson...</p>
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mt-2"></div>
                </div>
                <div id="customFoodError" class="hidden text-red-600 bg-red-100 p-3 rounded-lg my-2"></div>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="closeCustomFoodModal()" class="action-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
                    <button id="generateGuideBtn" onclick="generateCustomFoodGuide()" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">G√©n√©rer le Guide</button>
                </div>
            </div>
        </div>
        <div id="recipeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl w-full text-left transform transition-all scale-95 opacity-0" id="recipeModalBox">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="recipeModalTitle" class="text-xl font-bold text-gray-800">Recettes</h3>
                    <button onclick="closeRecipeModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <div id="recipeModalContent" class="prose max-w-none max-h-[70vh] overflow-y-auto pr-4"></div>
                <div id="recipeModalActions" class="mt-4 pt-4 border-t flex justify-end gap-3"></div>
            </div>
        </div>
        <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 opacity-0" id="alertModalBox">
                <h3 id="alertModalTitle" class="text-xl font-bold mb-3 text-red-700">Attention</h3>
                <p id="alertModalMessage" class="mb-4 text-gray-700"></p>
                <button onclick="closeAlertModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
    // --- CONFIGURATION & DATABASES ---
    const apiKey = ""; // La cl√© est inject√©e automatiquement dans cet environnement.
    const ACCESS_CODE = "bbq";

    const fuelDB = {
        general: {
            fuelTypes: ["Briquettes de charbon", "Charbon de bois"],
            woodTypes: ["Hickory", "Ch√™ne", "Mesquite", "Pommier", "Cerisier", "√ârable", "Aulne", "H√™tre", "C√®dre", "Aucun"]
        },
        recommendations: {
            boeuf: { fuel: "Briquettes de charbon", wood: "Hickory", notes: "Id√©al pour une fum√©e corc√©e et une chaleur stable sur la dur√©e." },
            porc: { fuel: "Briquettes de charbon", wood: "Pommier", notes: "Apporte une fum√©e douce et sucr√©e qui compl√®te parfaitement le porc." },
            volaille: { fuel: "Charbon de bois", wood: "Cerisier", notes: "Fournit une chaleur r√©active et une fum√©e l√©g√®re et fruit√©e." },
            poisson: { fuel: "Charbon de bois", wood: "Aulne", notes: "Br√ªle proprement avec une chaleur douce, parfait pour la chair d√©licate du poisson." },
            agneau: { fuel: "Briquettes de charbon", wood: "Hickory", notes: "Un bois de caract√®re qui se marie bien avec le go√ªt prononc√© de l'agneau." },
            legume: { fuel: "Charbon de bois", wood: "Pommier", notes: "Chaleur mod√©r√©e et fum√©e tr√®s l√©g√®re pour ne pas masquer le go√ªt." },
            default: { fuel: "Briquettes de charbon", wood: "Pommier", notes: "Un choix polyvalent et fiable pour la plupart des cuissons." }
        }
    };
    
    // foodDB enrichi avec des donn√©es de cuisson
    const foodDB = {
        "Recettes Personnalis√©es": {},
        "Plats & Sandwichs": {
            pizza: { name: "Pizza", type: 'default', duration: 480, targetTempBBQ: 280, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson Pizza", zone: "Indirecte", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Pr√©chauffer une pierre √† pizza en zone indirecte 20min. Glisser la pizza et cuire 6-8 minutes." }] }], rest: { duration: 120 } },
            burger: { name: "Burger Classique", type: 'boeuf', rub_friendly: true, duration: 480, targetTempBBQ: 190, targetTempInternal: 70, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe / Indirecte", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Griller 4 min par face. Ajouter le fromage la derni√®re minute et toaster les pains en indirect." }] }], rest: { duration: 0 } },
            smash_burger: { name: "Smash Burger", type: 'boeuf', rub_friendly: true, duration: 240, targetTempBBQ: 250, targetTempInternal: 75, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe (Plancha)", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Sur une plancha chaude, √©craser la boule de viande et cuire 2 min par face." }] }], rest: { duration: 0 } },
            croque_monsieur: { name: "Croque-monsieur", type: 'porc', duration: 600, targetTempBBQ: 180, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte / Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Placer en zone indirecte pour faire fondre le fromage, puis dorer 1 min en direct sur chaque face." }] }], rest: { duration: 0 } }
        },
        "B≈ìuf / Veau": {
            brisket: { name: "Poitrine de B≈ìuf (Brisket)", type: 'boeuf', rub_friendly: true, requiresWeight: true, targetTempBBQ: 115, targetTempInternal: 95, timePerKgSeconds: 12600, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer jusqu'√† atteindre la T¬∞ interne cible. Envelopper dans du papier boucher vers 75-80¬∞C." }] }], rest: { duration: 7200, action: "Reposer dans une glaci√®re (sans glace) pendant au moins 2 heures." } },
            steak_2_5cm: { name: "Steak / C√¥te de b≈ìuf (~2.5cm)", type: 'boeuf', rub_friendly: true, duration: 660, targetTempBBQ: 210, targetTempInternal: 54, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 3-4 min par face en direct, puis finir en indirect si n√©cessaire." }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            bifteck_4cm: { name: "Bifteck (~4cm)", type: 'boeuf', rub_friendly: true, duration: 900, targetTempBBQ: 200, targetTempInternal: 54, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 7-8 min par face en direct." }] }], rest: { duration: 300 } },
            bavette: { name: "Bavette d'aloyau", type: 'boeuf', rub_friendly: true, duration: 360, targetTempBBQ: 230, targetTempInternal: 52, methods: [{ type: "grill", steps: [{ name: "Saisie rapide", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 2-3 minutes par face pour une cuisson saignante." }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            picanha_entiere: { name: "Picanha (enti√®re, ~1.2kg)", type: 'boeuf', rub_friendly: true, duration: 2700, targetTempBBQ: 150, targetTempInternal: 52, methods: [{ type: "grill", steps: [{ name: "Cuisson indirecte", duration: 2400, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect, c√¥t√© gras vers le haut, jusqu'√† 48¬∞C √† coeur." }, { name: "Saisie finale", duration: 300, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir rapidement de tous les c√¥t√©s." }] }], rest: { duration: 900, action: "Laisser reposer 15 minutes." } },
            roti_cote_boeuf: { name: "R√¥ti de c√¥te de b≈ìuf (~2.5kg)", type: 'boeuf', rub_friendly: true, duration: 6300, targetTempBBQ: 145, targetTempInternal: 55, methods: [{ type: "grill", steps: [{ name: "Cuisson indirecte", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte jusqu'√† la temp√©rature √† coeur d√©sir√©e." }] }], rest: { duration: 900 } },
            rosbif: { name: "Rosbif d√©soss√© (~2kg)", type: 'boeuf', rub_friendly: true, duration: 8100, targetTempBBQ: 130, targetTempInternal: 55, methods: [{ type: "smoke", steps: [{ name: "Cuisson Low & Slow", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Cuire en zone indirecte jusqu'√† la temp√©rature √† coeur." }] }], rest: { duration: 900 } },
            steak_veau: { name: "Steak de veau (~3cm)", type: 'boeuf', rub_friendly: true, duration: 960, targetTempBBQ: 180, targetTempInternal: 60, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller 6-8 minutes de chaque c√¥t√© pour une cuisson ros√©e." }] }], rest: { duration: 300 } },
        },
        "Porc": {
            pulled_pork: { name: "√âpaule de porc (Pulled Pork)", type: 'porc', rub_friendly: true, requiresWeight: true, targetTempBBQ: 115, targetTempInternal: 95, timePerKgSeconds: 7200, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant 8-10 heures. Emballer lorsque la T¬∞ interne atteint 75¬∞C. Poursuivre jusqu'√† 95¬∞C." }] }], rest: { duration: 3600, action: "Laisser reposer dans une glaci√®re pendant au moins 1 heure avant d'effilocher." } },
            travers_porc: { name: "Travers de porc (Ribs)", type: 'porc', rub_friendly: true, duration: 16200, targetTempBBQ: 130, targetTempInternal: 92, methods: [{ type: "smoke", steps: [{ name: "Phase 1 (Fumage)", duration: 10800, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer 3h sur la grille." }, { name: "Phase 2 (Emball√©)", duration: 3600, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Emballer dans du papier aluminium avec un liquide et cuire 1h." }, { name: "Phase 3 (Sauce)", duration: 1800, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "D√©baller, appliquer la sauce et laisser caram√©liser 30min." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes." } },
            filet_mignon_porc: { name: "Filet Mignon (Saisie Invers√©e)", type: 'porc', rub_friendly: true, duration: 2400, targetTempBBQ: 155, targetTempInternal: 63, methods: [ { type: "grill", steps: [ { name: "Cuisson Indirecte", duration: 2100, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte jusqu'√† 58¬∞C √† coeur." }, { name: "Saisie Directe", duration: 300, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir rapidement de chaque c√¥t√©." } ]}], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            cotelette_porc: { name: "C√¥telette de porc (~3cm)", type: 'porc', rub_friendly: true, duration: 660, targetTempBBQ: 180, targetTempInternal: 65, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller 5-6 minutes de chaque c√¥t√©." }] }], rest: { duration: 300 } },
            araignee_porc: { name: "Araign√©e de Porc", type: 'porc', rub_friendly: true, duration: 360, targetTempBBQ: 235, targetTempInternal: 68, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir tr√®s rapidement chaque face. Se mange ros√©." }] }], rest: { duration: 120 } },
            saucisses_crues: { name: "Saucisses crues (2-zones)", type: 'porc', duration: 1080, targetTempBBQ: 160, targetTempInternal: 72, methods: [{ type: "grill", steps: [{ name: "Cuisson Indirecte", duration: 900, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte pour une cuisson √† coeur." }, { name: "Saisie Directe", duration: 180, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Terminer par une saisie rapide pour bien griller." }] }], rest: { duration: 0 } },
        },
         "Volaille": {
            poulet_entier: { name: "Poulet entier (~1.2kg)", type: 'volaille', rub_friendly: true, duration: 3300, targetTempBBQ: 180, targetTempInternal: 82, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en indirect jusqu'√† atteindre la temp√©rature √† coeur dans la cuisse." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes sous aluminium." } },
            blanc_poulet_desosse: { name: "Blanc de poulet d√©soss√©", type: 'volaille', rub_friendly: true, duration: 1050, targetTempBBQ: 160, targetTempInternal: 74, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte en retournant √† mi-cuisson." }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            cuisse_poulet: { name: "Cuisse de poulet", type: 'volaille', rub_friendly: true, duration: 1800, targetTempBBQ: 180, targetTempInternal: 82, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en zone indirecte en retournant √† mi-cuisson." }] }], rest: { duration: 300 } },
            aile_poulet: { name: "Aile de poulet", type: 'volaille', rub_friendly: true, duration: 1050, targetTempBBQ: 180, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en indirect, retourner √† mi-cuisson." }] }], rest: { duration: 180 } },
            magret_canard: { name: "Magret de canard", type: 'volaille', rub_friendly: true, duration: 750, targetTempBBQ: 190, targetTempInternal: 57, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte / Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Commencer c√¥t√© peau en indirect pour faire fondre le gras, puis saisir rapidement c√¥t√© chair." }] }], rest: { duration: 300 } },
            dinde_entiere: { name: "Dinde enti√®re (5.5-7kg)", type: 'volaille', rub_friendly: true, duration: 12600, targetTempBBQ: 170, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuisson indirecte longue." }] }], rest: { duration: 1200 } },
            oie_entiere: { name: "Oie enti√®re (5-7kg)", type: 'volaille', rub_friendly: true, duration: 12600, targetTempBBQ: 145, targetTempInternal: 70, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuisson indirecte tr√®s longue." }] }], rest: { duration: 1200 } },
        },
        "Agneau": {
             cotelette_agneau: { name: "C√¥telette d'agneau", type: 'agneau', rub_friendly: true, duration: 660, targetTempBBQ: 180, targetTempInternal: 60, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller 4-6 minutes par face pour une cuisson ros√©e." }] }], rest: { duration: 300 } },
             gigot_agneau: { name: "Gigot d'agneau r√¥ti", type: 'agneau', rub_friendly: true, requiresWeight: true, timePerKgSeconds: 3600, targetTempBBQ: 150, targetTempInternal: 58, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect jusqu'√† la temp√©rature d√©sir√©e. Saisir √† la fin si n√©cessaire." }] }], rest: { duration: 900 } },
             merguez: { name: "Merguez", type: 'agneau', duration: 420, targetTempBBQ: 200, targetTempInternal: 75, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller en retournant r√©guli√®rement." }] }], rest: { duration: 0 } },
        },
        "Poisson / Crustac√©s": {
            saumon_steak: { name: "Pav√© de saumon", type: 'poisson', duration: 540, targetTempBBQ: 160, targetTempInternal: 55, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte, c√¥t√© peau en premier si pr√©sente." }] }], rest: { duration: 0 } },
            thon_steak: { name: "Steak de thon", type: 'poisson', duration: 150, targetTempBBQ: 170, targetTempInternal: 51, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Saisir 2-3 minutes au total, l'int√©rieur doit rester ros√©." }] }], rest: { duration: 120 } },
            poisson_entier: { name: "Poisson entier (Bar, Dorade)", type: 'poisson', duration: 1200, targetTempBBQ: 180, targetTempInternal: 60, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire 10-15 min par face en indirect." }] }], rest: { duration: 0 } },
            crevettes: { name: "Crevettes / Langoustines", type: 'poisson', duration: 330, targetTempBBQ: 160, targetTempInternal: 70, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Griller rapidement jusqu'√† ce qu'elles deviennent roses." }] }], rest: { duration: 0 } },
            st_jacques: { name: "Coquilles St-Jacques", type: 'poisson', duration: 300, targetTempBBQ: 180, targetTempInternal: 55, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Saisir 2-3 minutes par face maximum." }] }], rest: { duration: 0 } },
            huitres: { name: "Hu√Ætres", type: 'poisson', duration: 270, targetTempBBQ: 160, targetTempInternal: 65, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirecte jusqu'√† ouverture." }] }], rest: { duration: 0 } },
        },
        "L√©gumes & Fruits": {
            epis_mais: { name: "√âpis de ma√Øs entier", type: 'legume', duration: 1050, targetTempBBQ: 155, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect, en tournant r√©guli√®rement." }] }], rest: { duration: 0 } },
            pomme_de_terre_papillote: { name: "Pomme de terre (en papillote)", type: 'legume', duration: 3600, targetTempBBQ: 180, targetTempInternal: 95, methods: [{ type: "grill", steps: [{ name: "Cuisson longue", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Envelopper dans de l'aluminium et placer en cuisson indirecte." }] }], rest: { duration: 0 } },
            asperges: { name: "Asperges", type: 'legume', duration: 420, targetTempBBQ: 160, targetTempInternal: 85, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Griller en les faisant rouler sur la grille." }] }], rest: { duration: 0 } },
            aubergine_tranches: { name: "Aubergines en tranches", type: 'legume', duration: 420, targetTempBBQ: 170, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller des deux c√¥t√©s jusqu'√† tendret√©." }] }], rest: { duration: 0 } },
            champignons: { name: "Champignons", type: 'legume', duration: 540, targetTempBBQ: 155, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en direct en remuant." }] }], rest: { duration: 0 } },
            poivron_entier: { name: "Poivron entier", type: 'legume', duration: 1650, targetTempBBQ: 155, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire jusqu'√† ce que la peau noircisse, puis la retirer." }] }], rest: { duration: 0 } },
            ananas: { name: "Ananas en tranches", type: 'legume', duration: 480, targetTempBBQ: 170, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller jusqu'√† caram√©lisation des deux c√¥t√©s." }] }], rest: { duration: 0 } },
            peche_nectarine: { name: "P√™che ou Nectarine", type: 'legume', duration: 540, targetTempBBQ: 170, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Placer c√¥t√© coup√© sur la grille jusqu'√† caram√©lisation." }] }], rest: { duration: 0 } },
            banane: { name: "Banane", type: 'legume', duration: 420, targetTempBBQ: 170, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire avec la peau jusqu'√† ce qu'elle noircisse." }] }], rest: { duration: 0 } },
            figues: { name: "Figues", type: 'legume', duration: 300, targetTempBBQ: 170, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Saisir rapidement pour caram√©liser." }] }], rest: { duration: 0 } },
        }
    };
    
    // --- √âTAT GLOBAL DE L'APPLICATION ---
    let appState = {};
    let historyStack = [];
    let intervalId = null, timelineInterval = null;
    let currentRecipe = null;
    let currentGeneratedPlan = null;
    const allPanelIds = ['saucesPanel', 'notebookPanel', 'referenceGuide'];
    let saucesDB = null;

    function resetAppState() {
        appState = {
            flow: null, mealTime: null, cookingMethod: null, cookingMode: 'single', selectedFoods: [], 
            fuel: { type: null, wood: null }, plan: null
        };
        historyStack = ['screen-home'];
    }

    // --- LOGIQUE DE NAVIGATION ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if (historyStack[historyStack.length - 1] !== screenId) {
            historyStack.push(screenId);
        }
        window.scrollTo(0, 0);
    }
    
    function goBack() {
        if (historyStack.length > 1) {
            historyStack.pop();
            const prevScreen = historyStack[historyStack.length - 1];
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(prevScreen).classList.add('active');
        }
    }

    function startFlow(flow) {
        resetAppState();
        appState.flow = flow;
        switch (flow) {
            case 'mealTime':
                const now = new Date();
                const defaultMealTime = new Date(now.getTime() + 4 * 3600 * 1000);
                document.getElementById('mealTimeInput').value = `${String(defaultMealTime.getHours()).padStart(2,'0')}:${String(defaultMealTime.getMinutes()).padStart(2,'0')}`;
                showScreen('screen-meal-time');
                break;
            case 'prepareNow':
            case 'readyNow':
                showScreen('screen-method');
                break;
        }
    }

    function setMealTime() {
        const timeValue = document.getElementById('mealTimeInput').value;
        if (!timeValue) { showAlert("Heure requise", "Veuillez choisir une heure."); return; }
        const [hours, minutes] = timeValue.split(':');
        const mealTime = new Date();
        mealTime.setHours(hours, minutes, 0, 0);
        if (mealTime < new Date()) { mealTime.setDate(mealTime.getDate() + 1); }
        appState.mealTime = mealTime;
        showScreen('screen-method');
    }

    function setCookingMethod(method) {
        appState.cookingMethod = method;
        showScreen('screen-cooking-mode');
    }

    function setCookingMode(mode) {
        appState.cookingMode = mode;
        populateFoodOptions();
        showScreen('screen-food-selection');
    }

    function populateFoodOptions() {
        const container = document.getElementById('food-options-container');
        container.innerHTML = '';
        const inputType = appState.cookingMode === 'single' ? 'radio' : 'checkbox';

        Object.entries(foodDB).forEach(([category, items]) => {
            let itemsHTML = '';
            let categoryHasItem = false;
            Object.entries(items).forEach(([key, item]) => {
                if (item.methods && item.methods.some(m => m.type === appState.cookingMethod)) {
                    categoryHasItem = true;
                    const weightInput = item.requiresWeight ? `<input type="number" step="0.1" min="0.5" class="w-24 border rounded p-1 text-center" placeholder="Poids (kg)" id="weight-${key}" onkeyup="event.stopPropagation()">` : '';
                    const rubCheckbox = item.rub_friendly ? `<div class="flex items-center text-xs"><input type="checkbox" id="rub-${key}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><label for="rub-${key}" class="ml-2 text-gray-700">Avec RUB</label></div>` : '';
                    
                    itemsHTML += `
                        <div class="food-item-container flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100" data-name="${item.name.toLowerCase()}">
                            <label class="flex items-center gap-4 cursor-pointer flex-grow">
                                <input type="${inputType}" name="food" value="${category}:${key}" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500">
                                <span>${item.name}</span>
                            </label>
                            <div class="flex items-center gap-4">
                                ${weightInput}
                                ${rubCheckbox}
                                <button onclick="event.stopPropagation(); getRecipes(currentRecipe = { id: '${key}', itemName: '${item.name}', text: '' })" class="text-xs bg-blue-100 text-blue-800 hover:bg-blue-200 font-semibold py-1 px-2 rounded-md">Recettes</button>
                            </div>
                        </div>`;
                }
            });
            if (categoryHasItem) {
                container.innerHTML += `<h3 class="food-category text-lg font-semibold text-gray-700 mt-4 border-b pb-1">${category}</h3>` + itemsHTML;
            }
        });
    }

    function setFoods() {
        appState.selectedFoods = [];
        const checkedFoods = document.querySelectorAll('input[name="food"]:checked');
        if (checkedFoods.length === 0) { showAlert("S√©lection requise", "Veuillez s√©lectionner au moins un aliment."); return; }
        let allWeightsValid = true;
        checkedFoods.forEach(el => {
            const [category, key] = el.value.split(':');
            const food = foodDB[category][key];
            let weight = null;
            if (food.requiresWeight) {
                const weightInput = document.getElementById(`weight-${key}`);
                weight = parseFloat(weightInput.value);
                if (isNaN(weight) || weight <= 0) {
                    weightInput.classList.add('border-red-500');
                    allWeightsValid = false;
                } else {
                     weightInput.classList.remove('border-red-500');
                }
            }
            const rubCheckbox = document.getElementById(`rub-${key}`);
            appState.selectedFoods.push({ id: key, key: key, food, weight, useRub: rubCheckbox ? rubCheckbox.checked : false });
        });
        
        if (!allWeightsValid) { showAlert("Poids invalide", "Veuillez entrer un poids valide pour les aliments s√©lectionn√©s."); return; }
        
        populateFuelScreen();
        showScreen('screen-fuel');
    }

    function populateFuelScreen() {
        const primaryFoodType = appState.selectedFoods.length > 0 ? appState.selectedFoods[0].food.type : 'default';
        const recommendation = fuelDB.recommendations[primaryFoodType] || fuelDB.recommendations.default;
        
        appState.fuel.type = recommendation.fuel;
        appState.fuel.wood = appState.cookingMethod === 'smoke' ? recommendation.wood : 'Aucun';

        document.getElementById('fuel-recommendation').innerHTML = `<p class="font-bold">Recommandation pour ${primaryFoodType}:</p><p>${recommendation.fuel} + ${recommendation.wood}. ${recommendation.notes}</p>`;
        
        const fuelSelect = document.getElementById('fuel-type-select');
        fuelSelect.innerHTML = fuelDB.general.fuelTypes.map(f => `<option value="${f}" ${f === appState.fuel.type ? 'selected' : ''}>${f}</option>`).join('');
        
        const woodSelect = document.getElementById('fuel-wood-select');
        woodSelect.innerHTML = fuelDB.general.woodTypes.map(w => `<option value="${w}" ${w === appState.fuel.wood ? 'selected' : ''}>${w}</option>`).join('');
        woodSelect.disabled = appState.cookingMethod !== 'smoke';
    }

    function setFuelAndGeneratePlan() {
        appState.fuel.type = document.getElementById('fuel-type-select').value;
        appState.fuel.wood = document.getElementById('fuel-wood-select').value;
        generateCookingPlan();
        displayPlanSummary();
        showScreen('screen-planning-summary');
    }

    // --- MOTEUR DE PLANIFICATION ---
    function generateCookingPlan() {
        const IGNITION_DURATION = 1200; // 20 min
        const PREHEAT_DURATION = 600; // 10 min
        let totalDuration = 0;
        let planSteps = [];

        if (appState.flow !== 'readyNow') {
            totalDuration = IGNITION_DURATION + PREHEAT_DURATION;
            planSteps.push({
                title: "√âtape 1: Allumage de la chemin√©e",
                duration: IGNITION_DURATION,
                action: "Ouvrez les a√©rations √† 100%. Allumez une chemin√©e de charbon et attendez que les braises soient incandescentes.",
                vents: "Bas: Pos 3 / Haut: 100%",
                isSetup: true
            });
            planSteps.push({
                title: "√âtape 2: Pr√©chauffage et Zonage",
                duration: PREHEAT_DURATION,
                action: `Versez les braises sur un c√¥t√© pour cr√©er deux zones. Fermez le couvercle et pr√©chauffez la grille. Visez une T¬∞ de ${appState.selectedFoods[0].food.targetTempBBQ}¬∞C.`,
                isSetup: true
            });
        }
        
        appState.selectedFoods.forEach((item, index) => {
            const food = item.food;
            let cookDuration = 0;
            const method = food.methods.find(m => m.type === appState.cookingMethod);
            
            let stepIndexOffset = planSteps.length;
            method.steps.forEach(step => {
                let duration = step.duration;
                if (!duration) { // If duration is per kg
                     if (food.requiresWeight && item.weight) {
                        duration = food.timePerKgSeconds * item.weight;
                     } else {
                        duration = food.duration; // Fallback to main duration
                     }
                }
                cookDuration += duration;
                planSteps.push({ ...step, title: `${food.name}: ${step.name || 'Cuisson'}`, duration: duration });
            });
           
            if (item.useRub) {
                 const firstCookStepIndex = planSteps.findIndex(step => !step.isSetup && step.title.startsWith(food.name));
                 if(firstCookStepIndex !== -1) {
                    planSteps[firstCookStepIndex].action = `<strong class='text-orange-500'>‚ö†Ô∏è AVEC RUB :</strong> Surveillez la coloration, les √©pices peuvent br√ªler plus vite.<br><br>` + planSteps[firstCookStepIndex].action;
                 }
            }

            totalDuration += cookDuration;
            if (food.rest && food.rest.duration > 0) {
                planSteps.push({ title: `Repos: ${food.name}`, duration: food.rest.duration, action: food.rest.action, isRest: true });
                totalDuration += food.rest.duration;
            }

            if (appState.cookingMode === 'multiple' && index < appState.selectedFoods.length - 1) {
                const nextFood = appState.selectedFoods[index + 1].food;
                const transitionDuration = 300; // 5 minutes buffer
                planSteps.push({
                    title: `Transition vers ${nextFood.name}`,
                    duration: transitionDuration,
                    action: `Pr√©parez la cuisson pour <strong>${nextFood.name}</strong>. V√©rifiez la temp√©rature du BBQ (${nextFood.targetTempBBQ}¬∞C) et ajustez les a√©rations si n√©cessaire.`,
                    isTransition: true
                });
                totalDuration += transitionDuration;
            }
        });
        
        let startTime, endTime;
        if (appState.flow === 'mealTime') {
            endTime = appState.mealTime;
            startTime = new Date(endTime.getTime() - totalDuration * 1000);
        } else {
            startTime = new Date();
            endTime = new Date(startTime.getTime() + totalDuration * 1000);
        }
        
        let cumulativeTime = startTime.getTime();
        planSteps.forEach(step => {
            step.startTime = new Date(cumulativeTime);
            cumulativeTime += step.duration * 1000;
            step.endTime = new Date(cumulativeTime);
        });
        
        appState.plan = { startTime, endTime, totalDuration, steps: planSteps };
    }

    function displayPlanSummary() {
        const { startTime, endTime, totalDuration, steps } = appState.plan;
        const summaryDiv = document.getElementById('summary-content');
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        let summaryHTML = `
            <div class="bg-gray-100 p-4 rounded-lg text-center">
                <p>Heure de d√©marrage : <strong class="text-2xl text-red-700">${formatTime(startTime)}</strong></p>
                <p>Repas pr√™t √† : <strong class="text-2xl text-green-600">${formatTime(endTime)}</strong></p>
                <p>Dur√©e totale estim√©e : <strong>${Math.floor(totalDuration/3600)}h ${Math.round((totalDuration%3600)/60)}min</strong></p>
            </div>
            <h3 class="font-bold mt-6 text-xl">Chronologie d√©taill√©e :</h3>
            <div class="border-l-2 border-gray-300 pl-4 space-y-4 mt-2">
        `;
        steps.forEach(step => {
            summaryHTML += `<div><p class="font-semibold">${formatTime(step.startTime)} - ${step.title}</p><p class="text-sm text-gray-600 ml-2">(${Math.round(step.duration / 60)} min) - ${step.action}</p></div>`;
        });
        summaryHTML += `</div>`;
        summaryDiv.innerHTML = summaryHTML;
    }

    function startCooking() {
        document.getElementById('wizard').style.display = 'none';
        document.getElementById('cooking-timeline-section').classList.remove('hidden');
        displayTimeline();
        startTimeline();
    }
    
    // --- GESTION DE LA TIMELINE DE CUISSON ---
    function displayTimeline() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        appState.plan.steps.forEach((step, index) => {
             const detailsHTML = `
                <div class="text-right text-xs mt-2 grid grid-cols-3 gap-2 text-gray-600">
                    ${step.zone ? `<div><strong>Zone:</strong><br>${step.zone}</div>` : ''}
                    ${step.vents ? `<div><strong>Vents:</strong><br>${step.vents}</div>` : ''}
                    ${step.grille ? `<div><strong>Grille:</strong><br>${step.grille}</div>` : ''}
                </div>
            `;

            container.innerHTML += `
                <div id="timeline-step-${index}" class="p-4 border rounded-lg bg-white transition-all duration-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-700"><span class="font-mono text-gray-500">${formatTime(step.startTime)}</span> - ${step.title}</p>
                            <div class="text-sm text-gray-600 ml-2 mt-1">${step.action || ''}</div>
                        </div>
                         <div class="status-icon text-gray-400 text-2xl">‚è≥</div>
                    </div>
                    ${step.isTransition ? '' : detailsHTML}
                </div>`;
        });
    }

    function startTimeline() {
        clearInterval(timelineInterval);
        let currentTimelineStepIndex = -1;
        
        function updateTimeline() {
            const now = new Date().getTime();
            let activeStepIndex = appState.plan.steps.findIndex(step => now >= step.startTime.getTime() && now < step.endTime.getTime());
            
            if (activeStepIndex === -1 && now >= appState.plan.endTime.getTime()) {
                 activeStepIndex = appState.plan.steps.length; // Finished
            }

            if (activeStepIndex !== currentTimelineStepIndex) {
                currentTimelineStepIndex = activeStepIndex;
                appState.plan.steps.forEach((step, index) => {
                    const stepEl = document.getElementById(`timeline-step-${index}`);
                    if (!stepEl) return;
                    const iconEl = stepEl.querySelector('.status-icon');
                    stepEl.classList.remove('opacity-50', 'bg-gray-100', 'bg-yellow-100', 'border-yellow-400', 'shadow-lg');
                    iconEl.classList.remove('text-green-500');

                    if (step.endTime.getTime() < now) { // Completed step
                        stepEl.classList.add('opacity-50', 'bg-gray-100');
                        iconEl.innerHTML = '‚úÖ';
                        iconEl.classList.add('text-green-500');
                    } else if (index === currentTimelineStepIndex) { // Active step
                        stepEl.classList.add('bg-yellow-100', 'border-yellow-400', 'shadow-lg');
                        iconEl.innerHTML = '‚ñ∂Ô∏è';
                        document.getElementById('currentStep').textContent = step.title;
                        startStepCountdown(step);
                    }
                });
                 
                if (currentTimelineStepIndex >= appState.plan.steps.length) { // All steps are done
                    clearInterval(intervalId);
                    clearInterval(timelineInterval);
                    document.getElementById('currentStep').textContent = "CUISSON TERMIN√âE !";
                    timerDisplay.textContent = "00:00";
                }
            }
        }
        updateTimeline();
        timelineInterval = setInterval(updateTimeline, 1000);
    }
    
    function startStepCountdown(step) {
        clearInterval(intervalId);
        const update = () => {
            const remaining = Math.round((step.endTime.getTime() - new Date().getTime()) / 1000);
            if (remaining >= 0) {
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            } else {
                 timerDisplay.textContent = "00:00";
            }
        };
        update();
        intervalId = setInterval(update, 1000);
    }
    
    // --- FONCTIONS DES PANNEAUX LATERAUX ET MODALES ---
    const getHistory = () => JSON.parse(localStorage.getItem('bbq_recipe_history') || '[]');
    const saveToHistory = (recipe) => { let history = getHistory(); if (!history.some(r => r.id === recipe.id)) { history.unshift(recipe); localStorage.setItem('bbq_recipe_history', JSON.stringify(history.slice(0, 50))); } };
    const getFavorites = () => JSON.parse(localStorage.getItem('bbq_recipe_favorites') || '[]');
    const saveToFavorites = (recipe) => { let favorites = getFavorites(); if (!favorites.some(r => r.id === recipe.id)) { favorites.unshift(recipe); localStorage.setItem('bbq_recipe_favorites', JSON.stringify(favorites)); } };
    const removeFromFavorites = (recipeId) => { let favorites = getFavorites(); favorites = favorites.filter(r => r.id !== recipeId); localStorage.setItem('bbq_recipe_favorites', JSON.stringify(favorites)); };

    function togglePanel(panelIdToOpen) { allPanelIds.forEach(id => { if (id !== panelIdToOpen) { document.getElementById(id).classList.remove('visible'); } }); const panel = document.getElementById(panelIdToOpen); panel.classList.toggle('visible'); if (panel.classList.contains('visible')) { if (panelIdToOpen === 'saucesPanel') { loadAndDisplaySauces(); } } }
    
    async function callGemini(prompt, isJson = false) {
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        if (isJson) { payload.generationConfig = { responseMimeType: "application/json" }; }
        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) { console.error("API Error:", await response.json()); throw new Error("API Call Failed"); }
        const result = await response.json();
        return result.candidates[0].content.parts[0].text;
    }

    async function loadAndDisplaySauces() {
        const container = document.getElementById('saucesPanelContent');
        if (!saucesDB) {
            container.innerHTML = '<p class="text-center p-4">Chargement des recettes de base...</p>';
            const prompt = `Agis comme un chef sp√©cialis√© en barbecue. Cr√©e un guide de pr√©parations. Retourne UNIQUEMENT un objet JSON valide. La structure doit avoir 3 cl√©s principales: "Sauce", "Marinade", "RUB". Pour chaque cl√©, la valeur est un objet o√π chaque cl√© est un type de viande (ex: "Boeuf", "Porc", "Volaille", "Poisson"). La valeur pour chaque type de viande doit √™tre un tableau d'au moins 2 objets recette. Chaque objet recette doit avoir "name", "ingredients" (tableau de strings), et "preparation" (string). Toutes les recettes doivent √™tre sans gluten. Ne renvoie rien d'autre que l'objet JSON.`;
            try {
                const result = await callGemini(prompt, true);
                saucesDB = JSON.parse(result);
            } catch (error) {
                container.innerHTML = `<p class="text-red-500 p-4">Erreur de chargement des recettes de base.</p>`;
                return;
            }
        }
        displayPrepTypeSelection();
    }

    function displayPrepTypeSelection() {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = 'Choisir une pr√©paration';
        document.getElementById('saucesBackButton').classList.add('hidden');
        container.innerHTML = `
            <div class="list-item font-semibold" onclick="showMeatCategories('Sauce')">Sauces</div>
            <div class="list-item font-semibold" onclick="showMeatCategories('Marinade')">Marinades</div>
            <div class="list-item font-semibold" onclick="showMeatCategories('RUB')">RUBs (√âpices s√®ches)</div>
        `;
    }

    function showMeatCategories(prepType) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = `Choisir une viande pour : ${prepType}`;
        document.getElementById('saucesBackButton').classList.remove('hidden');
        container.innerHTML = '';
        Object.keys(saucesDB[prepType]).forEach(meatType => {
            container.innerHTML += `<div class="list-item font-semibold" onclick="displaySauceList('${prepType}', '${meatType}')">${meatType}</div>`;
        });
    }

    function displaySauceList(prepType, meatType) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = `Recettes pour : ${meatType}`;
        container.innerHTML = '';
        saucesDB[prepType][meatType].forEach(recipe => {
            container.innerHTML += `<div class="list-item" onclick='displaySauceRecipe(${JSON.stringify(recipe)})'>${recipe.name}</div>`;
        });
    }

    function displaySauceRecipe(recipe) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = recipe.name;
        container.innerHTML = `
            <h3 class="text-lg font-bold text-gray-800 mt-2 mb-2">Ingr√©dients</h3>
            <ul class="list-disc list-inside text-gray-700 space-y-1">${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>
            <h3 class="text-lg font-bold text-gray-800 mt-4 mb-2">Pr√©paration</h3>
            <p class="text-gray-700 whitespace-pre-line">${recipe.preparation}</p>
        `;
    }

    function goBackSauces() { displayPrepTypeSelection(); }

    async function getRecipes() {
        const modal = document.getElementById('recipeModal'); const modalBox = document.getElementById('recipeModalBox'); const content = document.getElementById('recipeModalContent'); const title = document.getElementById('recipeModalTitle');
        modal.classList.remove('hidden'); setTimeout(() => modalBox.classList.remove('scale-95', 'opacity-0'), 10);
        title.textContent = `Recettes pour ${currentRecipe.itemName}`;
        content.innerHTML = '<p>Gemini r√©fl√©chit √† une recette et √† son plan de cuisson...</p>';
        const prompt = `Pour une recette de "${currentRecipe.itemName}", g√©n√®re un objet JSON unique. Cet objet doit contenir deux cl√©s: "displayText" et "cookingPlan".
        1. "displayText": Une cha√Æne de caract√®res format√©e en Markdown simple contenant une recette (titre, ingr√©dients, pr√©paration).
        2. "cookingPlan": Un objet JSON structur√© pour une app de BBQ avec les cl√©s: "name" (string), "type" (string, ex: 'boeuf'), "rub_friendly": true, "duration" (number, secondes), "targetTempBBQ" (number, Celsius), "targetTempInternal" (number, Celsius), "methods" (tableau avec un objet: {type: 'grill' ou 'smoke', steps: [{name, duration, action, zone, grille, vents}]}), et "rest" ({duration}).
        Toute la recette doit √™tre sans gluten. Ne renvoie que l'objet JSON.`;
        try {
            const jsonString = await callGemini(prompt, true);
            const recipeData = JSON.parse(jsonString);

            currentRecipe.text = recipeData.displayText;
            currentGeneratedPlan = recipeData.cookingPlan; // Store the plan

            if (currentRecipe.id.toString().length < 10) currentRecipe.id = Date.now();
            saveToHistory(currentRecipe);
            displayRecipe();
        } catch (error) { 
            console.error("Recipe generation error:", error);
            content.innerHTML = `<p class="text-red-500">D√©sol√©, une erreur est survenue lors de la g√©n√©ration de la recette.</p>`; 
        }
    }

    function displayRecipe() {
        const content = document.getElementById('recipeModalContent');
        const actions = document.getElementById('recipeModalActions');
        let html = currentRecipe.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/### (.*)/g, '<h3 class="text-lg font-semibold mt-4">$1</h3>').replace(/## (.*)/g, '<h2 class="text-xl font-bold mt-6 border-b pb-2 mb-2">$1</h2>').replace(/\n- /g, '\n<li>').replace(/\n/g, '<br>');
        html = html.replace(/<li>(.*?)<br>/g, '<li>$1</li>').replace(/(<li>.*?<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul><ul>/g, '');
        content.innerHTML = html;
        
        const isFavorite = getFavorites().some(fav => fav.id === currentRecipe.id);
        actions.innerHTML = `
            <button onclick="useGeneratedPlan()" class="action-button bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Cuisiner cette recette</button>
            <button id="favBtn" onclick="toggleFavorite()" class="action-button ${isFavorite ? 'bg-yellow-500' : 'bg-gray-200'} text-gray-800 font-bold py-2 px-4 rounded-lg">${isFavorite ? 'Retirer des favoris' : 'Ajouter aux favoris'}</button>
        `;
    }

    function useGeneratedPlan() {
        if (!currentGeneratedPlan) {
            showAlert("Erreur", "Aucun plan de cuisson n'a √©t√© g√©n√©r√©.");
            return;
        }
        closeRecipeModal();
        const customKey = `custom_${Date.now()}`;
        foodDB["Recettes Personnalis√©es"][customKey] = currentGeneratedPlan;
        
        showScreen('screen-food-selection');
        populateFoodOptions();
        
        document.querySelectorAll('input[name="food"]').forEach(el => el.checked = false);
        const newFoodInput = document.querySelector(`input[value="Recettes Personnalis√©es:${customKey}"]`);
        if(newFoodInput) {
            newFoodInput.checked = true;
            newFoodInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            setFoods();
        } else {
            showAlert("Erreur", "Impossible de s√©lectionner la recette g√©n√©r√©e.");
        }
    }

    function toggleFavorite() {
        const isFavorite = getFavorites().some(fav => fav.id === currentRecipe.id);
        if (isFavorite) removeFromFavorites(currentRecipe.id);
        else saveToFavorites(currentRecipe);
        displayRecipe();
    }
    
    function filterAndSearchFoods() {
        const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
        document.querySelectorAll('.food-item-container').forEach(item => {
            item.classList.toggle('hidden', !item.dataset.name.includes(searchTerm));
        });
        document.querySelectorAll('.food-category').forEach(category => {
            let hasVisibleItem = false;
            let sibling = category.nextElementSibling;
            while(sibling && !sibling.classList.contains('food-category')) {
                if (!sibling.classList.contains('hidden')) { hasVisibleItem = true; break; }
                sibling = sibling.nextElementSibling;
            }
            category.classList.toggle('hidden', !hasVisibleItem);
        });
        const visibleCount = document.querySelectorAll('.food-item-container:not(.hidden)').length;
        document.getElementById('generateFoodContainer').classList.toggle('hidden', !(visibleCount === 0 && searchTerm.length > 2));
    }
    
    // --- FONCTIONS UTILITAIRES ET INITIALISATION ---
    function resetApp() {
        clearInterval(intervalId); clearInterval(timelineInterval);
        resetAppState();
        document.getElementById('wizard').style.display = 'block';
        document.getElementById('cooking-timeline-section').classList.add('hidden');
        showScreen('screen-home');
    }
    
    function checkPassword() {
        if (document.getElementById('passwordInput').value === ACCESS_CODE) {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }

    function showAlert(title, message) { document.getElementById('alertModalTitle').textContent = title; document.getElementById('alertModalMessage').textContent = message; const modal = document.getElementById('alertModal'); const modalBox = document.getElementById('alertModalBox'); modal.classList.remove('hidden'); setTimeout(() => modalBox.classList.remove('scale-95', 'opacity-0'), 10); }
    function closeAlertModal() { const modalBox = document.getElementById('alertModalBox'); modalBox.classList.add('scale-95', 'opacity-0'); setTimeout(() => document.getElementById('alertModal').classList.add('hidden'), 200); }
    function closeRecipeModal() { const modalBox = document.getElementById('recipeModalBox'); modalBox.classList.add('scale-95', 'opacity-0'); setTimeout(() => document.getElementById('recipeModal').classList.add('hidden'), 200); }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('passwordInput').focus();
        document.getElementById('passwordInput').addEventListener('keyup', (e) => e.key === "Enter" && checkPassword());
        resetApp();
    });

    </script>
</body>
</html>

