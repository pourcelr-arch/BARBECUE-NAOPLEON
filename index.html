<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant BBQ Pro v2</title>

    <!-- M√©tadonn√©es pour l'application web -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Guide Pro BBQ">

    <!-- Ic√¥ne de l'application -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='192' height='192' fill='%232D3748' viewBox='0 0 256 256'%3E%3Crect width='256' height='256' fill='none'%3E%3C/rect%3E%3Cpath d='M208,104c0-44.2-35.8-80-80-80S48,59.8,48,104Z' opacity='0.2'%3E%3C/path%3E%3Cpath d='M216,104a88,88,0,0,1-176,0Z' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/path%3E%3Cline x1='40' y1='104' x2='216' y2='104' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cline x1='96' y1='104' x2='80' y2='224' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cline x1='160' y1='104' x2='176' y2='224' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/line%3E%3Cpath d='M80,224a56,56,0,0,0,96,0' fill='none' stroke='%232D3748' stroke-linecap='round' stroke-linejoin='round' stroke-width='16'%3E%3C/path%3E%3C/svg%3E">

    <!-- Chargement de Tailwind CSS et Tone.js -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; background-color: #f7fafc; color: #1a202c; line-height: 1.6; }
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .kettle-bg { background-color: #2D3748; border-radius: 1rem; color: white; padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .action-button { transition: all 0.2s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .action-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .action-button:disabled { cursor: not-allowed; background-color: #9ca3af; }
        .wizard-card { background-color: white; padding: 1.5rem; border-radius: 0.75rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); margin-top: 2rem; }
        .wizard-title { font-size: 1.5rem; font-weight: 700; color: #1a202c; margin-bottom: 1rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 0.5rem; }
        .home-choice-card { text-align: center; padding: 2rem 1.5rem; border: 1px solid #e2e8f0; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s ease-in-out; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .home-choice-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-color: #c53030; }
        .nav-button { background-color: #4a5568; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; }
        #timerDisplay { font-size: 2.5rem; font-weight: 700; color: #FBBF24; }
        .side-panel { position: fixed; top: 1rem; width: 350px; height: 80vh; background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 100; transition: transform 0.3s ease-in-out; }
        .side-panel-left { left: 1rem; transform: translateX(-110%); }
        .side-panel-right { right: 1rem; transform: translateX(110%); }
        .side-panel.visible { transform: translateX(0); }
        .side-panel-content { height: calc(100% - 3rem); overflow-y: auto; padding: 1rem; font-size: 0.9rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; } .prose h2 { font-size: 1.25rem; font-weight: bold; margin-top: 1rem; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem; } .prose h3 { font-size: 1.1rem; font-weight: bold; margin-top: 0.75rem; } .prose strong { color: #c53030; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #e2e8f0; cursor: pointer; transition: background-color 0.2s; } .list-item:hover { background-color: #f7fafc; }
        .prose table { width: 100%; margin-top: 1em; margin-bottom: 1em; border-collapse: collapse; border: 1px solid #fcd34d; }
        .prose td { border: 1px solid #fef08a; padding: 0.5em 0.75em; }
        .prose tr:first-child { background-color: #fef9c3; font-weight: bold; }
        .prose tr:nth-child(even) { background-color: #fefce8; }
    </style>
</head>
<body class="px-4 sm:px-8 pt-8 pb-8">

    <div id="passwordModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-[300]">
        <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center">
            <h3 class="text-xl font-bold mb-3 text-gray-800">Acc√®s s√©curis√©</h3>
            <p class="mb-4 text-gray-700">Veuillez entrer le code d'acc√®s.</p>
            <input type="password" id="passwordInput" class="border p-2 w-full rounded mb-4">
            <button onclick="checkPassword()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg w-full">Entrer</button>
            <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">Code incorrect.</p>
        </div>
    </div>

    <div id="mainApp" class="hidden max-w-4xl mx-auto">
        <header class="text-center mb-6 relative">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">Assistant Pro : <span class="text-red-700">BBQ The Pitmaster IA</span></h1>
            <p class="text-lg text-gray-600">Votre planification de cuisson parfaite commence ici.</p>
        </header>

        <!-- NAVIGATION WIZARD -->
        <div id="wizard">
            <!-- √âCRAN 1: ACCUEIL -->
            <div id="screen-home" class="screen active">
                <div class="wizard-card text-center">
                    <h2 class="wizard-title">Comment voulez-vous commencer ?</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="home-choice-card" onclick="startFlow('mealTime')">
                            <div>
                                <div class="text-5xl mb-4">üóìÔ∏è</div>
                                <h3 class="font-bold text-xl mb-2">Je choisis mon heure de repas</h3>
                            </div>
                            <p class="text-gray-600">L'assistant calcule pour vous l'heure de d√©marrage et g√©n√®re un planning complet.</p>
                        </div>
                        <div class="home-choice-card" onclick="startFlow('prepareNow')">
                            <div>
                                <div class="text-5xl mb-4">üî•</div>
                                <h3 class="font-bold text-xl mb-2">Je pr√©pare mon BBQ maintenant</h3>
                            </div>
                            <p class="text-gray-600">Lancez un guide pas-√†-pas ou une timeline pour une cuisson qui d√©marre tout de suite.</p>
                        </div>
                        <div class="home-choice-card" onclick="startFlow('readyNow')">
                            <div>
                                <div class="text-5xl mb-4">‚úÖ</div>
                                <h3 class="font-bold text-xl mb-2">Mon BBQ est d√©j√† pr√™t</h3>
                            </div>
                            <p class="text-gray-600">Indiquez ce qui est sur la grille et obtenez des instructions adapt√©es.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 2: HEURE DU REPAS -->
            <div id="screen-meal-time" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üóìÔ∏è √Ä quelle heure souhaitez-vous manger ?</h2>
                    <input type="time" id="mealTimeInput" class="border p-3 text-2xl w-full rounded-lg text-center">
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setMealTime()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Suivant</button>
                    </div>
                </div>
            </div>
            
            <!-- √âCRAN 3: M√âTHODE DE CUISSON -->
            <div id="screen-method" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üî• Quelle technique de cuisson ?</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onclick="setCookingMethod('grill')" class="action-button bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Cuisson / Grill</button>
                        <button onclick="setCookingMethod('smoke')" class="action-button bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 px-6 rounded-lg flex-1 text-xl">Fumage</button>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                    </div>
                </div>
            </div>
            
            <!-- √âCRAN 4: MODE DE CUISSON -->
            <div id="screen-cooking-mode" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">‚öôÔ∏è Mode de cuisson</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mt-6">
                        <button onclick="setCookingMode('single')" class="action-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex-1 text-xl">Un seul aliment</button>
                        <button onclick="setCookingMode('multiple')" class="action-button bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg flex-1 text-xl">Plusieurs aliments</button>
                    </div>
                    <div class="flex justify-between mt-8">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 5: S√âLECTION DES ALIMENTS -->
            <div id="screen-food-selection" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üçñ Que voulez-vous cuisiner ?</h2>
                    <div id="selected-foods-summary" class="mb-4 p-3 bg-gray-100 rounded-lg min-h-[50px]"></div>
                    
                    <h3 class="font-semibold mb-2">Filtrer par cat√©gorie :</h3>
                    <div id="food-category-filters" class="grid grid-cols-3 sm:grid-cols-4 gap-2 mb-4"></div>

                    <input type="text" id="foodSearchInput" onkeyup="filterAndSearchFoods()" class="border p-2 w-full rounded my-4" placeholder="Rechercher un plat, une viande, un l√©gume...">
                    <div id="food-options-container" class="space-y-3 mb-6 max-h-[40vh] overflow-y-auto pr-2"></div>
                    
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="confirmFoodSelection()" id="confirm-food-btn" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg" disabled>Suivant</button>
                    </div>
                </div>
            </div>
            
            <!-- √âCRAN 6: PR√âPARATION -->
            <div id="screen-preparation" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üßÇ Choix de la Pr√©paration</h2>
                    <div id="preparation-options-container" class="space-y-4"></div>
                     <p class="text-sm text-gray-600 mt-2">L'application adaptera les instructions de cuisson en fonction de votre choix.</p>
                     <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setPreparation()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Suivant</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 7: COMBUSTIBLE -->
            <div id="screen-fuel" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">ü™µ Choix du Combustible</h2>
                    <div id="fuel-recommendation" class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-2">Type de combustible :</h3>
                            <select id="fuel-type-select" class="border p-2 w-full rounded"></select>
                        </div>
                        <div>
                            <h3 class="font-semibold mb-2">Bois de fumage :</h3>
                            <select id="fuel-wood-select" class="border p-2 w-full rounded"></select>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="setFuelAndGeneratePlan()" class="action-button bg-red-600 text-white font-bold py-2 px-6 rounded-lg">G√©n√©rer le Planning</button>
                    </div>
                </div>
            </div>

            <!-- √âCRAN 8: R√âSUM√â DU PLANNING -->
            <div id="screen-planning-summary" class="screen">
                <div class="wizard-card">
                    <h2 class="wizard-title">üìã Votre Plan de Cuisson</h2>
                    <div id="weather-alert" class="hidden my-4 p-4 rounded-lg"></div>
                    <div id="summary-content" class="space-y-4"></div>
                    <div class="flex justify-between mt-6">
                        <button onclick="goBack()" class="nav-button">Retour</button>
                        <button onclick="startCooking()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg">D√©marrer la Cuisson !</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION CUISSON ACTIVE -->
        <div id="cooking-timeline-section" class="hidden">
            <div class="kettle-bg mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Suivi de la Cuisson</h2>
                    <button onclick="showTroubleshootingModal()" class="action-button bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg text-sm">‚ùì Un probl√®me ?</button>
                </div>
                 <div id="live-weather-display" class="text-sm flex justify-center items-center gap-4 mb-4 text-gray-300"></div>
                <div class="flex flex-col sm:flex-row justify-between items-center bg-gray-700 p-4 rounded-lg">
                    <div class="text-center mb-4 sm:mb-0">
                        <p class="text-gray-400">Minuteur de l'√©tape :</p>
                        <div id="timerDisplay">00:00</div>
                    </div>
                    <div class="text-center">
                        <p class="text-gray-400">√âtape en cours :</p>
                        <p id="currentStep" class="text-xl font-semibold text-yellow-400">EN ATTENTE</p>
                    </div>
                </div>
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2 text-center text-xs">
                    <div class="bg-gray-800 p-2 rounded-lg">
                        <p class="text-gray-400">T¬∞ BBQ CIBLE</p>
                        <p id="bbqTempTile" class="font-bold text-lg text-white">-</p>
                    </div>
                    <div class="bg-gray-800 p-2 rounded-lg">
                        <p class="text-gray-400">T¬∞ VIANDE CIBLE</p>
                        <p id="internalTempTile" class="font-bold text-lg text-white">-</p>
                    </div>
                    <div class="bg-gray-800 p-2 rounded-lg">
                        <p class="text-gray-400">R√âGLAGE VENTS</p>
                        <p id="ventsTile" class="font-bold text-sm text-white">-</p>
                    </div>
                    <div class="bg-gray-800 p-2 rounded-lg">
                        <p class="text-gray-400">POSITION GRILLE</p>
                        <p id="grilleTile" class="font-bold text-sm text-white">-</p>
                    </div>
                </div>
            </div>
            <div id="start-cooking-prompt" class="text-center my-4 hidden">
                <button onclick="beginPreparation()" class="action-button bg-green-600 text-white font-bold py-3 px-8 rounded-lg text-lg animate-pulse">
                    Lancer la Pr√©paration !
                </button>
            </div>
            <div class="text-center mb-4">
                 <button id="history-toggle" onclick="toggleHistory(this)" class="text-sm text-blue-600 hover:underline hidden">Afficher l'historique</button>
            </div>
            <div id="timeline-container" class="space-y-2"></div>
            <button onclick="resetApp()" class="action-button w-full mt-8 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                Terminer & R√©initialiser la Session
            </button>
        </div>

        <!-- Boutons flottants -->
        <div class="fixed top-4 left-4 z-[101] flex flex-col gap-2">
            <button id="saucesToggle" onclick="togglePanel('saucesPanel')" class="action-button bg-orange-500 hover:bg-orange-600 text-white p-3 rounded-full shadow-lg" aria-label="Sauces et Marinades">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3.1 8a5.87 5.87 0 0 1 7.17 3.01A6 6 0 0 1 10 18a6 6 0 0 1-6-6c0-1.74.78-3.32 2-4.42Z"/><path d="m14 4 1-1 1 1"/><path d="M12 22a2 2 0 0 0 2-2v-2H10v2a2 2 0 0 0 2 2Z"/></svg>
            </button>
            <button id="notebookToggle" onclick="togglePanel('notebookPanel')" class="action-button bg-blue-600 text-white p-3 rounded-full shadow-lg" aria-label="Mon Carnet">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 6h4"/><path d="M2 12h4"/><path d="M2 18h4"/><path d="M6 4v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2z"/></svg>
            </button>
        </div>
        <div class="fixed top-4 right-4 z-[101]">
            <button id="referenceToggle" onclick="togglePanel('referenceGuide')" class="action-button bg-gray-800 text-white p-3 rounded-full shadow-lg" aria-label="Aide-m√©moire">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
            </button>
        </div>

        <!-- Panneaux Lat√©raux -->
        <div id="saucesPanel" class="side-panel side-panel-left">
            <div class="flex items-center p-2 bg-gray-100 border-b">
                <button id="saucesBackButton" onclick="goBackSauces()" class="hidden p-1 mr-2 text-blue-600 hover:bg-gray-200 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </button>
                <h3 id="saucesTitle" class="font-bold flex-1">Sauces & Marinades</h3>
                <button onclick="togglePanel('saucesPanel')" class="p-1">&times;</button>
            </div>
            <div id="saucesPanelContent" class="side-panel-content"></div>
        </div>
        <div id="referenceGuide" class="side-panel side-panel-right">
            <div class="flex justify-between items-center p-2 bg-gray-100 border-b"><h3 class="font-bold">Aide-M√©moire</h3><button onclick="togglePanel('referenceGuide')" class="p-1">&times;</button></div>
            <div id="referenceGuideContent" class="side-panel-content prose max-w-none"></div>
        </div>
        <div id="notebookPanel" class="side-panel side-panel-left">
            <div class="flex justify-between items-center p-2 bg-gray-100 border-b"><h3 class="font-bold">Mon Carnet de Recettes</h3><button onclick="togglePanel('notebookPanel')" class="p-1">&times;</button></div>
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button onclick="showNotebookTab('favorites')" id="tab-favorites" class="w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm text-blue-600 border-blue-600">Favoris</button>
                    <button onclick="showNotebookTab('history')" id="tab-history" class="w-1/2 py-3 px-1 text-center border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">Historique</button>
                </nav>
            </div>
            <div id="notebookContentFavorites" class="side-panel-content"></div>
            <div id="notebookContentHistory" class="side-panel-content hidden"></div>
        </div>

        <!-- Modales -->
        <div id="troubleshootingModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
             <div class="bg-white p-6 rounded-lg shadow-2xl max-w-lg w-full text-left transform transition-all scale-95 opacity-0" id="troubleshootingModalBox">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">Aide √† la cuisson</h3>
                    <button onclick="closeTroubleshootingModal()" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <div id="troubleshootingContent" class="prose max-w-none max-h-[70vh] overflow-y-auto pr-4">
                    <p>Quel est votre probl√®me ?</p>
                    <div class="space-y-3 mt-4">
                        <button onclick="showTroubleshootingHelp('temp')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üå°Ô∏è Ma temp√©rature est instable (trop haute / trop basse)</button>
                        <button onclick="showTroubleshootingHelp('stall')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üßê Ma cuisson stagne (le fameux "stall")</button>
                        <button onclick="showTroubleshootingHelp('flareup')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üî• J'ai des flammes soudaines (flare-up)</button>
                    </div>
                </div>
             </div>
        </div>

        <div id="customFoodModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-md w-full text-left transform transition-all scale-95 opacity-0" id="customFoodModalBox">
                <h3 id="customFoodModalTitle" class="text-xl font-bold text-gray-800 mb-3">Ajouter un aliment personnalis√©</h3>
                <p id="customFoodModalText" class="text-gray-600 mb-4">Quel aliment souhaitez-vous cuire ?</p>
                <input type="text" id="customFoodInput" class="border p-2 w-full rounded mt-2 mb-4" placeholder="Ex: C√¥te de porc √©paisse">
                <div id="customFoodLoader" class="hidden text-center my-4">
                    <p>Gemini pr√©pare votre guide de cuisson...</p>
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mt-2"></div>
                </div>
                <div id="customFoodError" class="hidden text-red-600 bg-red-100 p-3 rounded-lg my-2"></div>
                <div class="flex justify-end gap-3 mt-4">
                    <button onclick="closeCustomFoodModal()" class="action-button bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Annuler</button>
                    <button id="generateGuideBtn" onclick="generateCustomFoodGuide()" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">G√©n√©rer le Guide</button>
                </div>
            </div>
        </div>
        <div id="recipeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-2xl w-full text-left transform transition-all scale-95 opacity-0" id="recipeModalBox">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="recipeModalTitle" class="text-xl font-bold text-gray-800">Recettes</h3>
                    <button onclick="closeRecipeModal()" class="text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                 <div id="recipePreference" class="mb-4">
                    <label for="recipePreferenceInput" class="block text-sm font-medium text-gray-700">Ajouter une pr√©f√©rence ? (facultatif)</label>
                    <input type="text" id="recipePreferenceInput" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-red-500 focus:border-red-500 sm:text-sm" placeholder="Ex: avec du ch√®vre, plus √©pic√©...">
                </div>
                <div id="recipeModalContent" class="prose max-w-none max-h-[60vh] overflow-y-auto pr-4"></div>
                <div id="recipeModalActions" class="mt-4 pt-4 border-t flex justify-between items-center gap-3"></div>
            </div>
        </div>
        <div id="alertModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center p-4 z-[200]">
            <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full text-center transform transition-all scale-95 opacity-0" id="alertModalBox">
                <h3 id="alertModalTitle" class="text-xl font-bold mb-3 text-red-700">Attention</h3>
                <p id="alertModalMessage" class="mb-4 text-gray-700"></p>
                <button onclick="closeAlertModal()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">OK</button>
            </div>
        </div>
    </div>

    <script>
    // --- CONFIGURATION & DATABASES ---
    const apiKey = ""; // La cl√© est inject√©e automatiquement dans cet environnement.
    const ACCESS_CODE = "bbq";

    const fuelDB = {
        general: {
            fuelTypes: ["Briquettes de charbon", "Charbon en morceaux"],
            woodTypes: ["Hickory", "Ch√™ne", "Mesquite", "Pommier", "Cerisier", "√ârable", "Aulne", "H√™tre", "C√®dre", "Aucun"]
        },
        recommendations: {
            boeuf: { fuel: "Briquettes de charbon", wood: "Hickory", notes: "Id√©al pour une fum√©e corc√©e et une chaleur stable sur la dur√©e." },
            porc: { fuel: "Briquettes de charbon", wood: "Pommier", notes: "Apporte une fum√©e douce et sucr√©e qui compl√®te parfaitement le porc." },
            volaille: { fuel: "Charbon en morceaux", wood: "Cerisier", notes: "Fournit une chaleur r√©active et une fum√©e l√©g√®re et fruit√©e." },
            poisson: { fuel: "Charbon en morceaux", wood: "Aulne", notes: "Br√ªle proprement avec une chaleur douce, parfait pour la chair d√©licate du poisson." },
            agneau: { fuel: "Briquettes de charbon", wood: "Hickory", notes: "Un bois de caract√®re qui se marie bien avec le go√ªt prononc√© de l'agneau." },
            legume: { fuel: "Charbon en morceaux", wood: "Pommier", notes: "Chaleur mod√©r√©e et fum√©e tr√®s l√©g√®re pour ne pas masquer le go√ªt." },
            default: { fuel: "Briquettes de charbon", wood: "Pommier", notes: "Un choix polyvalent et fiable pour la plupart des cuissons." }
        }
    };
    
    // foodDB enrichi avec des donn√©es de cuisson
    const foodDB = {
        "Recettes Personnalis√©es": {},
        "Plats & Sandwichs": {
            pizza: { name: "Pizza", type: 'default', duration: 480, targetTempBBQ: 280, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson Pizza", zone: "Indirecte", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Pr√©chauffer une pierre √† pizza en zone indirecte 20min. Glisser la pizza et cuire 6-8 minutes." }] }], rest: { duration: 120 } },
            burger: { name: "Burger Classique", type: 'boeuf', rub_friendly: true, duration: 480, targetTempBBQ: 190, targetTempInternal: 70, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe / Indirecte", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Griller 4 min par face. Ajouter le fromage la derni√®re minute et toaster les pains en indirect.", flippable: true }] }], rest: { duration: 0 } },
            smash_burger: { name: "Smash Burger", type: 'boeuf', rub_friendly: true, duration: 240, targetTempBBQ: 250, targetTempInternal: 75, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe (Plancha)", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Sur une plancha chaude, √©craser la boule de viande et cuire 2 min par face.", flippable: true }] }], rest: { duration: 0 } },
            croque_monsieur: { name: "Croque-monsieur", type: 'porc', duration: 600, targetTempBBQ: 180, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte / Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Placer en zone indirecte pour faire fondre le fromage, puis dorer 1 min en direct sur chaque face.", flippable: true }] }], rest: { duration: 0 } }
        },
        "B≈ìuf / Veau": {
            brisket: { name: "Poitrine de B≈ìuf (Brisket)", type: 'boeuf', rub_friendly: true, requiresWeight: true, targetTempBBQ: 115, targetTempInternal: 95, timePerKgSeconds: 12600, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer jusqu'√† atteindre la T¬∞ interne cible. Envelopper dans du papier boucher vers 75-80¬∞C." }] }], rest: { duration: 7200, action: "Reposer dans une glaci√®re (sans glace) pendant au moins 2 heures." } },
            pastrami: { name: "Pastrami (Brisket)", type: 'boeuf', rub_friendly: true, requiresWeight: true, targetTempBBQ: 120, targetTempInternal: 95, timePerKgSeconds: 7200, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Apr√®s saumurage et dessalage, fumer pendant 6-8h jusqu'√† atteindre la temp√©rature √† coeur." }] }], rest: { duration: 7200, action: "Laisser refroidir compl√®tement, id√©alement une nuit au frigo." } },
            steak_2_5cm: { name: "Steak / C√¥te de b≈ìuf (~2.5cm)", type: 'boeuf', rub_friendly: true, duration: 660, targetTempBBQ: 210, targetTempInternal: 54, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 3-4 min par face en direct, puis finir en indirect si n√©cessaire.", flippable: true }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            bifteck_4cm: { name: "Bifteck (~4cm)", type: 'boeuf', rub_friendly: true, duration: 900, targetTempBBQ: 200, targetTempInternal: 54, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 7-8 min par face en direct.", flippable: true }] }], rest: { duration: 300 } },
            short_ribs: { name: "Short Ribs de boeuf", type: 'boeuf', rub_friendly: true, duration: 21600, targetTempBBQ: 125, targetTempInternal: 96, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant 5-6 heures, en vaporisant de temps en temps. Envelopper si le 'stall' est trop long." }] }], rest: { duration: 3600, action: "Reposer au moins 1 heure dans une glaci√®re." } },
            tomahawk: { name: "Steak Tomahawk", type: 'boeuf', rub_friendly: true, duration: 3600, targetTempBBQ: 120, targetTempInternal: 54, methods: [{ type: "grill", steps: [{ name: "Cuisson indirecte", duration: 3000, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 50%", action: "Cuire en indirect jusqu'√† 48¬∞C √† coeur (saisie invers√©e)." }, { name: "Saisie", duration: 600, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 2-3 minutes par face sur braises vives." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes." } },
            tri_tip: { name: "Tri-Tip (Pointe de surlonge)", type: 'boeuf', rub_friendly: true, duration: 2700, targetTempBBQ: 135, targetTempInternal: 56, methods: [{ type: "grill", steps: [{ name: "Cuisson indirecte", duration: 2100, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect jusqu'√† 50¬∞C √† coeur." }, { name: "Saisie", duration: 600, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir rapidement sur toutes les faces." }] }], rest: { duration: 900, action: "Laisser reposer 15 minutes avant de trancher contre le grain." } },
            bavette: { name: "Bavette d'aloyau", type: 'boeuf', rub_friendly: true, duration: 360, targetTempBBQ: 230, targetTempInternal: 52, methods: [{ type: "grill", steps: [{ name: "Saisie rapide", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir 2-3 minutes par face pour une cuisson saignante.", flippable: true }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
        },
        "Porc": {
            pulled_pork: { name: "√âpaule de porc (Pulled Pork)", type: 'porc', rub_friendly: true, requiresWeight: true, targetTempBBQ: 115, targetTempInternal: 95, timePerKgSeconds: 7200, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant 8-10 heures. Emballer lorsque la T¬∞ interne atteint 75¬∞C. Poursuivre jusqu'√† 95¬∞C." }] }], rest: { duration: 3600, action: "Laisser reposer dans une glaci√®re pendant au moins 1 heure avant d'effilocher." } },
            pork_belly_burnt_ends: { name: "Pork Belly Burnt Ends", type: 'porc', rub_friendly: true, duration: 14400, targetTempBBQ: 125, targetTempInternal: 90, methods: [{ type: "smoke", steps: [{ name: "Fumage", duration: 10800, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Couper la poitrine en cubes, appliquer le rub et fumer 3h." }, { name: "Braising", duration: 3600, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Mettre les cubes dans une barquette alu avec beurre, cassonade, miel et couvrir. Cuire 1h √† 1h30." }] }], rest: { duration: 600, action: "Laisser la sauce √©paissir √† d√©couvert 10-15 min." } },
            pork_belly: { name: "Poitrine de porc enti√®re", type: 'porc', rub_friendly: true, duration: 18000, targetTempBBQ: 110, targetTempInternal: 95, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant 4-5 heures jusqu'√† ce que la viande soit tendre." }] }], rest: { duration: 1800, action: "Laisser reposer 30 minutes avant de trancher." } },
            travers_porc_st_louis: { name: "Travers de porc (St. Louis)", type: 'porc', rub_friendly: true, duration: 18000, targetTempBBQ: 125, targetTempInternal: 92, methods: [{ type: "smoke", steps: [{ name: "Fumage (3h)", duration: 10800, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer 3h, en vaporisant toutes les heures." }, { name: "Emballage (2h)", duration: 7200, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Emballer dans du papier aluminium avec un liquide (jus de pomme) et cuire 2h." }, { name: "Sauce (1h)", duration: 3600, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "D√©baller, appliquer la sauce et laisser caram√©liser 1h." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes." } },
            filet_mignon_porc: { name: "Filet Mignon (Saisie Invers√©e)", type: 'porc', rub_friendly: true, duration: 2400, targetTempBBQ: 155, targetTempInternal: 63, methods: [ { type: "grill", steps: [ { name: "Cuisson Indirecte", duration: 2100, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte jusqu'√† 58¬∞C √† coeur." }, { name: "Saisie Directe", duration: 300, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Saisir rapidement de chaque c√¥t√©.", flippable: true } ]}], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            cotelette_porc: { name: "C√¥telette de porc (~3cm)", type: 'porc', rub_friendly: true, duration: 660, targetTempBBQ: 180, targetTempInternal: 65, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller 5-6 minutes de chaque c√¥t√©.", flippable: true }] }], rest: { duration: 300 } },
            saucisses_crues: { name: "Saucisses crues (2-zones)", type: 'porc', duration: 1080, targetTempBBQ: 160, targetTempInternal: 72, methods: [{ type: "grill", steps: [
                { name: "Cuisson √† coeur", duration: 840, zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte pour une cuisson √† coeur, en retournant √† mi-cuisson.", flippable: true }, 
                { name: "Saisie Directe", duration: 240, zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 100%", action: "Terminer par une saisie rapide de tous les c√¥t√©s pour bien griller." }
            ] }], rest: { duration: 0 } },
        },
         "Volaille": {
            poulet_entier: { name: "Poulet entier (~1.2kg)", type: 'volaille', rub_friendly: true, duration: 3300, targetTempBBQ: 180, targetTempInternal: 82, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en indirect jusqu'√† atteindre la temp√©rature √† coeur dans la cuisse." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes sous aluminium." } },
            applewood_chicken: { name: "Poulet fum√© √† la pomme", type: 'volaille', rub_friendly: true, duration: 7200, targetTempBBQ: 125, targetTempInternal: 75, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer 2h √† 2h30 jusqu'√† atteindre la temp√©rature cible. Appliquer la sauce 20 min avant la fin." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes." } },
            beer_can_chicken: { name: "Beer Can Chicken", type: 'volaille', rub_friendly: true, duration: 4500, targetTempBBQ: 180, targetTempInternal: 82, methods: [{ type: "grill", steps: [{ name: "Cuisson Verticale", zone: "Indirecte", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire 'assis' sur une canette de bi√®re √† moiti√© pleine, en cuisson indirecte." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes avant de d√©couper." } },
            spatchcock_chicken: { name: "Poulet en Crapaudine", type: 'volaille', rub_friendly: true, duration: 2700, targetTempBBQ: 200, targetTempInternal: 75, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire c√¥t√© peau vers le haut en indirect. Placer des briques sur le poulet pour une peau extra-croustillante." }] }], rest: { duration: 600, action: "Laisser reposer 10 minutes." } },
            blanc_poulet_desosse: { name: "Blanc de poulet d√©soss√©", type: 'volaille', rub_friendly: true, duration: 1050, targetTempBBQ: 160, targetTempInternal: 74, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en zone indirecte en retournant √† mi-cuisson.", flippable: true }] }], rest: { duration: 300, action: "Laisser reposer 5 minutes." } },
            cuisse_poulet: { name: "Cuisse de poulet", type: 'volaille', rub_friendly: true, duration: 1800, targetTempBBQ: 180, targetTempInternal: 82, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en zone indirecte en retournant √† mi-cuisson.", flippable: true }] }], rest: { duration: 300 } },
            aile_poulet: { name: "Aile de poulet", type: 'volaille', rub_friendly: true, duration: 1050, targetTempBBQ: 180, targetTempInternal: 80, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire en indirect, retourner √† mi-cuisson.", flippable: true }] }], rest: { duration: 180 } },
            magret_canard: { name: "Magret de canard", type: 'volaille', rub_friendly: true, duration: 750, targetTempBBQ: 190, targetTempInternal: 57, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte / Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Commencer c√¥t√© peau en indirect pour faire fondre le gras, puis saisir rapidement c√¥t√© chair." }] }], rest: { duration: 300 } },
        },
        "Agneau": {
              cotelette_agneau: { name: "C√¥telette d'agneau", type: 'agneau', rub_friendly: true, duration: 660, targetTempBBQ: 180, targetTempInternal: 60, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller 4-6 minutes par face pour une cuisson ros√©e.", flippable: true }] }], rest: { duration: 300 } },
              gigot_agneau: { name: "Gigot d'agneau r√¥ti", type: 'agneau', rub_friendly: true, requiresWeight: true, timePerKgSeconds: 3600, targetTempBBQ: 150, targetTempInternal: 58, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect jusqu'√† la temp√©rature d√©sir√©e. Saisir √† la fin si n√©cessaire." }] }], rest: { duration: 900 } },
              lamb_shoulder: { name: "√âpaule d'agneau confite", type: 'agneau', rub_friendly: true, requiresWeight: true, timePerKgSeconds: 7200, targetTempBBQ: 130, targetTempInternal: 95, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant 6-8 heures jusqu'√† ce que la viande s'effiloche facilement." }] }], rest: { duration: 1800, action: "Laisser reposer 30 minutes avant d'effilocher." } },
              merguez: { name: "Merguez", type: 'agneau', duration: 420, targetTempBBQ: 200, targetTempInternal: 75, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Directe", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Griller en retournant r√©guli√®rement.", flippable: true }] }], rest: { duration: 0 } },
        },
        "Poisson / Crustac√©s": {
            saumon_fume: { name: "Saumon fum√© √† chaud", type: 'poisson', duration: 2400, targetTempBBQ: 100, targetTempInternal: 60, methods: [{ type: "smoke", steps: [{ name: "Fumage sur planche", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer sur une planche de c√®dre pr√©-tremp√©e pendant 30-40 minutes." }] }], rest: { duration: 0 } },
            truite_fumee: { name: "Truite enti√®re fum√©e", type: 'poisson', duration: 3600, targetTempBBQ: 100, targetTempInternal: 63, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer pendant environ 1 heure." }] }], rest: { duration: 300 } },
            thon_steak: { name: "Steak de thon", type: 'poisson', duration: 150, targetTempBBQ: 170, targetTempInternal: 51, methods: [{ type: "grill", steps: [{ name: "Saisie", zone: "Directe", grille: "Basse (Pos 1)", vents: "Bas: Pos 3 / Haut: 75%", action: "Saisir 2-3 minutes au total, l'int√©rieur doit rester ros√©.", flippable: true }] }], rest: { duration: 120 } },
            poisson_entier: { name: "Poisson entier (Bar, Dorade)", type: 'poisson', duration: 1200, targetTempBBQ: 180, targetTempInternal: 60, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Moyenne (Pos 2)", vents: "Bas: Pos 3 / Haut: 75%", action: "Cuire 10-15 min par face en indirect.", flippable: true }] }], rest: { duration: 0 } },
        },
        "L√©gumes & Fruits": {
            ail_fume: { name: "Ail fum√©", type: 'legume', duration: 3600, targetTempBBQ: 90, targetTempInternal: 85, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer des t√™tes d'ail enti√®res pendant 1h." }] }], rest: { duration: 0 } },
            poivron_fume: { name: "Poivron fum√©", type: 'legume', duration: 2700, targetTempBBQ: 110, targetTempInternal: 90, methods: [{ type: "smoke", steps: [{ name: "Fumage", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer jusqu'√† ce que la peau cloque et noircisse, puis la retirer." }] }], rest: { duration: 0 } },
            fromage_fume: { name: "Fromage √† p√¢te dure fum√©", type: 'default', duration: 7200, targetTempBBQ: 30, targetTempInternal: 20, methods: [{ type: "smoke", steps: [{ name: "Fumage √† froid", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 1 / Haut: 25%", action: "Fumer √† tr√®s basse temp√©rature (inf√©rieure √† 30¬∞C) pendant 2 √† 4 heures. Utiliser un g√©n√©rateur de fum√©e froide." }] }], rest: { duration: 86400, action: "Laisser reposer emball√© au frigo pendant au moins 24h." } },
            epis_mais: { name: "√âpis de ma√Øs entier", type: 'legume', duration: 1050, targetTempBBQ: 155, targetTempInternal: 90, methods: [{ type: "grill", steps: [{ name: "Cuisson", zone: "Indirecte", grille: "Haute (Pos 3)", vents: "Bas: Pos 2 / Haut: 50%", action: "Cuire en indirect, en tournant r√©guli√®rement." }] }], rest: { duration: 0 } },
        }
    };
    
    // --- √âTAT GLOBAL DE L'APPLICATION ---
    let appState = {};
    let historyStack = [];
    let intervalId = null, stepTimeoutId = null;
    let currentRecipe = null;
    let currentGeneratedPlan = null;
    const allPanelIds = ['saucesPanel', 'notebookPanel', 'referenceGuide'];

    function resetAppState() {
        appState = {
            flow: null, mealTime: null, cookingMethod: null, cookingMode: 'single', selectedFoods: [], 
            fuel: { type: null, wood: null }, plan: null, weather: null,
            cookingState: {
                currentStepIndex: -1,
                currentStepEndsAt: null, // ISO String
            }
        };
        historyStack = ['screen-home'];
    }

    // --- LOGIQUE DE NAVIGATION ---
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        if (historyStack[historyStack.length - 1] !== screenId) {
            historyStack.push(screenId);
        }
        window.scrollTo(0, 0);
    }
    
    function goBack() {
        if (historyStack.length > 1) {
            historyStack.pop();
            const prevScreen = historyStack[historyStack.length - 1];
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(prevScreen).classList.add('active');
        }
    }

    async function startFlow(flow) {
        resetAppState();
        appState.flow = flow;
        
        await getWeather(); // Get weather at the beginning of any flow.

        switch (flow) {
            case 'mealTime':
                const now = new Date();
                const defaultMealTime = new Date(now.getTime() + 4 * 3600 * 1000);
                document.getElementById('mealTimeInput').value = `${String(defaultMealTime.getHours()).padStart(2,'0')}:${String(defaultMealTime.getMinutes()).padStart(2,'0')}`;
                showScreen('screen-meal-time');
                break;
            case 'prepareNow':
            case 'readyNow':
                showScreen('screen-method');
                break;
        }
    }

    function setMealTime() {
        const timeValue = document.getElementById('mealTimeInput').value;
        if (!timeValue) { showAlert("Heure requise", "Veuillez choisir une heure."); return; }
        const [hours, minutes] = timeValue.split(':');
        const mealTime = new Date();
        mealTime.setHours(hours, minutes, 0, 0);
        if (mealTime < new Date()) { mealTime.setDate(mealTime.getDate() + 1); }
        appState.mealTime = mealTime.toISOString();
        showScreen('screen-method');
    }

    function setCookingMethod(method) {
        appState.cookingMethod = method;
        showScreen('screen-cooking-mode');
    }

    function setCookingMode(mode) {
        appState.cookingMode = mode;
        const maxSelection = mode === 'single' ? 1 : 2;
        setupFoodSelectionScreen(maxSelection);
        showScreen('screen-food-selection');
    }

    function setupFoodSelectionScreen(maxSelection) {
        appState.selectedFoods = [];
        updateSelectedFoodsSummary();
        populateCategoryFilters();
        populateAllFoodItems(maxSelection);
        // Set a default filter
        setTimeout(() => filterFoodList('Tous'), 0);
    }

    function populateCategoryFilters() {
        const container = document.getElementById('food-category-filters');
        container.innerHTML = '';
        const categories = {
            'Tous': 'üçΩÔ∏è', 'Volaille': 'üêì', 'B≈ìuf / Veau': 'üêÑ', 'Porc': 'üêñ', 'Agneau': 'üêë', 
            'Poisson / Crustac√©s': 'üêü', 'L√©gumes & Fruits': 'ü•ï', 'Plats & Sandwichs': 'üçî'
        };

        Object.entries(categories).forEach(([name, emoji]) => {
            const tile = document.createElement('button');
            tile.className = 'p-2 border rounded-lg shadow-sm text-center cursor-pointer hover:bg-gray-100 flex flex-col items-center justify-center category-filter-btn';
            tile.dataset.category = name;
            tile.innerHTML = `<div class="text-2xl">${emoji}</div><div class="mt-1 text-xs font-semibold">${name}</div>`;
            tile.onclick = () => filterFoodList(name);
            container.appendChild(tile);
        });
    }

    function populateAllFoodItems(maxSelection) {
        const container = document.getElementById('food-options-container');
        container.innerHTML = '';

        Object.entries(foodDB).forEach(([category, items]) => {
            if (category === "Recettes Personnalis√©es") return; 
            
            Object.entries(items).forEach(([key, item]) => {
                if (item.methods && item.methods.some(m => m.type === appState.cookingMethod)) {
                    const weightInput = item.requiresWeight ? `<input type="number" step="0.1" min="0.5" class="w-24 border rounded p-1 text-center" placeholder="Poids (kg)" id="weight-${key}" onkeyup="event.stopPropagation()">` : '';
                    
                    container.innerHTML += `
                        <div class="food-item-container flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100" data-name="${item.name.toLowerCase()}" data-category="${category}">
                            <label class="flex items-center gap-4 cursor-pointer flex-grow">
                                <input type="checkbox" name="food" value="${category}:${key}" class="h-5 w-5 text-red-600 border-gray-300 rounded focus:ring-red-500" onchange="toggleFoodSelection(this, ${maxSelection})">
                                <span>${item.name}</span>
                            </label>
                            <div class="flex items-center gap-4">
                                ${weightInput}
                                 <button onclick="event.stopPropagation(); triggerGetRecipes({ id: '${key}', itemName: '${item.name}', text: '' })" class="text-xs bg-blue-100 text-blue-800 hover:bg-blue-200 font-semibold py-1 px-2 rounded-md">Recette</button>
                            </div>
                        </div>`;
                }
            });
        });
    }

    function toggleFoodSelection(checkbox, maxSelection) {
        const [category, key] = checkbox.value.split(':');
        if (checkbox.checked) {
            if (appState.selectedFoods.length < maxSelection) {
                appState.selectedFoods.push({ category, key, preparation: 'none' });
            } else {
                checkbox.checked = false;
                showAlert('S√©lection maximale atteinte', `Vous ne pouvez s√©lectionner que ${maxSelection} aliment(s).`);
            }
        } else {
            appState.selectedFoods = appState.selectedFoods.filter(f => f.key !== key);
        }
        updateSelectedFoodsSummary();
    }

    function updateSelectedFoodsSummary() {
        const container = document.getElementById('selected-foods-summary');
        if (appState.selectedFoods.length === 0) {
            container.innerHTML = `<p class="text-gray-500 text-center">Aucun aliment s√©lectionn√©.</p>`;
        } else {
            container.innerHTML = `
                <h3 class="font-semibold mb-2">Mes Aliments S√©lectionn√©s :</h3>
                <div class="flex flex-wrap gap-2">
                    ${appState.selectedFoods.map(f => `<span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-0.5 rounded">${foodDB[f.category][f.key].name}</span>`).join('')}
                </div>`;
        }
        document.getElementById('confirm-food-btn').disabled = appState.selectedFoods.length === 0;
    }

    function confirmFoodSelection() {
        let allWeightsValid = true;
        appState.selectedFoods.forEach(food => {
            const foodData = foodDB[food.category][food.key];
            if (foodData.requiresWeight) {
                const weightInput = document.getElementById(`weight-${food.key}`);
                const weight = parseFloat(weightInput.value);
                if (isNaN(weight) || weight <= 0) {
                    weightInput.classList.add('border-red-500');
                    allWeightsValid = false;
                } else {
                    weightInput.classList.remove('border-red-500');
                    food.weight = weight;
                }
            }
        });

        if (!allWeightsValid) {
            showAlert("Poids invalide", "Veuillez entrer un poids valide pour les aliments s√©lectionn√©s.");
            return;
        }
        populatePreparationScreen();
        showScreen('screen-preparation');
    }
    
    function populatePreparationScreen() {
        const container = document.getElementById('preparation-options-container');
        container.innerHTML = '';

        appState.selectedFoods.forEach((food, index) => {
            const foodData = foodDB[food.category][food.key];
            const foodName = foodData.name;

            const preparationsHTML = `
                <div class="mt-4 border-t pt-4">
                    <h3 class="font-semibold text-lg">${foodName}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-100"><input type="radio" name="preparation-${index}" value="none" checked class="mr-2">Aucune</label>
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-100"><input type="radio" name="preparation-${index}" value="rub" class="mr-2">Rub</label>
                        <label class="p-4 border rounded-lg cursor-pointer hover:bg-gray-100"><input type="radio" name="preparation-${index}" value="marinade" class="mr-2">Marinade</label>
                    </div>
                </div>
            `;
            container.innerHTML += preparationsHTML;
        });
    }

    function setPreparation() {
        appState.selectedFoods.forEach((food, index) => {
            const prepValue = document.querySelector(`input[name="preparation-${index}"]:checked`).value;
            food.preparation = prepValue;
        });
        showScreen('screen-fuel');
        populateFuelScreen();
    }
    
    function filterAndSearchFoods() {
        const searchTerm = document.getElementById('foodSearchInput').value.toLowerCase();
        const activeCategory = document.querySelector('.category-filter-btn.bg-blue-100')?.dataset.category || 'Tous';

        document.querySelectorAll('.food-item-container').forEach(item => {
            const matchesCategory = (activeCategory === 'Tous' || item.dataset.category === activeCategory);
            const matchesSearch = item.dataset.name.includes(searchTerm);

            item.classList.toggle('hidden', !(matchesCategory && matchesSearch));
        });
    }

    function filterFoodList(categoryName) {
        document.querySelectorAll('.category-filter-btn').forEach(btn => {
            btn.classList.toggle('bg-blue-100', btn.dataset.category === categoryName);
            btn.classList.toggle('border-blue-400', btn.dataset.category === categoryName);
        });
        filterAndSearchFoods();
    }

    function populateFuelScreen() {
        const primaryFood = foodDB[appState.selectedFoods[0].category][appState.selectedFoods[0].key];
        const primaryFoodType = primaryFood.type || 'default';
        const recommendation = fuelDB.recommendations[primaryFoodType] || fuelDB.recommendations.default;
        
        appState.fuel.type = recommendation.fuel;
        appState.fuel.wood = appState.cookingMethod === 'smoke' ? recommendation.wood : 'Aucun';

        document.getElementById('fuel-recommendation').innerHTML = `<p class="font-bold">Recommandation pour ${primaryFoodType}:</p><p>${recommendation.fuel} + ${recommendation.wood}. ${recommendation.notes}</p>`;
        
        const fuelSelect = document.getElementById('fuel-type-select');
        fuelSelect.innerHTML = fuelDB.general.fuelTypes.map(f => `<option value="${f}" ${f === appState.fuel.type ? 'selected' : ''}>${f}</option>`).join('');
        
        const woodSelect = document.getElementById('fuel-wood-select');
        woodSelect.innerHTML = fuelDB.general.woodTypes.map(w => `<option value="${w}" ${w === appState.fuel.wood ? 'selected' : ''}>${w}</option>`).join('');
        woodSelect.disabled = appState.cookingMethod !== 'smoke';
    }

    function setFuelAndGeneratePlan() {
        appState.fuel.type = document.getElementById('fuel-type-select').value;
        appState.fuel.wood = document.getElementById('fuel-wood-select').value;
        generateCookingPlan();
        displayPlanSummary();
        showScreen('screen-planning-summary');
    }

    // --- MOTEUR DE PLANIFICATION ---
    function generateCookingPlan() {
        let IGNITION_DURATION = 1200; // 20 min
        let PREHEAT_DURATION = 600; // 10 min
        let planSteps = [];
        let totalDuration = 0;

        if (appState.weather && appState.weather.temperature < 10) {
            PREHEAT_DURATION *= 1.5;
        }

        const firstFoodData = foodDB[appState.selectedFoods[0].category][appState.selectedFoods[0].key];
        const firstCookStep = firstFoodData.methods.find(m => m.type === appState.cookingMethod).steps[0];
        const initialTargetTemp = firstFoodData.targetTempBBQ;

        if (appState.flow !== 'readyNow') {
            totalDuration = IGNITION_DURATION + PREHEAT_DURATION;
            planSteps.push({
                title: "√âtape 1: Allumage de la chemin√©e",
                duration: IGNITION_DURATION,
                action: "Ouvrez les a√©rations √† 100%. Allumez une chemin√©e de charbon et attendez que les braises soient incandescentes.",
                vents: "Bas: Pos 3 / Haut: 100%",
                grille: "N/A",
                isSetup: true
            });
            planSteps.push({
                title: "√âtape 2: Pr√©chauffage et Zonage",
                duration: PREHEAT_DURATION,
                action: `Versez les braises sur un c√¥t√© pour cr√©er deux zones. Fermez le couvercle et pr√©chauffez. <strong>Ajustez les a√©rations pour atteindre ${initialTargetTemp}¬∞C.</strong><br><small>Astuce: Ouvrez les a√©rations pour plus de chaleur, fermez-les partiellement pour en r√©duire.</small>`,
                vents: firstCookStep.vents,
                grille: firstCookStep.grille,
                isSetup: true
            });
        } else {
             planSteps.push({
                title: "√âtape 1: Ajustement de la Temp√©rature",
                duration: 0,
                action: `Votre BBQ est pr√™t. La cuisson n√©cessite une temp√©rature de <strong>${initialTargetTemp}¬∞C</strong>. Ajustez vos a√©rations pour atteindre cette cible avant de commencer.`,
                vents: firstCookStep.vents,
                grille: firstCookStep.grille,
                isSetup: true,
                isManualValidation: true
            });
        }
        
        appState.selectedFoods.forEach((item, index) => {
            const food = foodDB[item.category][item.key];
            let cookDuration = 0;
            const method = food.methods.find(m => m.type === appState.cookingMethod);
            
            method.steps.forEach(originalStep => {
                let duration = originalStep.duration;
                if (!duration && food.requiresWeight && item.weight) {
                    duration = food.timePerKgSeconds * item.weight;
                }
                
                let stepAction = originalStep.action;
                if (item.preparation === 'marinade') {
                    stepAction += "<br><small class='text-blue-500'>Note (Marinade): Un bac d'eau est conseill√© pour maintenir l'humidit√©.</small>";
                } else if (item.preparation === 'rub') {
                    stepAction += "<br><small class='text-orange-500'>Note (Rub): Surveillez la coloration pour √©viter de br√ªler le rub.</small>";
                }

                if (originalStep.flippable && duration > 60) {
                    const halfDuration = Math.round(duration / 2);
                    planSteps.push({ ...originalStep, duration: halfDuration, title: `${food.name}: ${originalStep.name || 'Cuisson'} (c√¥t√© 1)`, action: stepAction });
                    planSteps.push({ ...originalStep, duration: halfDuration, title: `${food.name}: ${originalStep.name || 'Cuisson'} (c√¥t√© 2)`, action: `<strong>Retournez la viande</strong> et continuez la cuisson.` });
                    cookDuration += duration;
                } else {
                    planSteps.push({ ...originalStep, title: `${food.name}: ${originalStep.name || 'Cuisson'}`, duration, action: stepAction });
                    cookDuration += duration;
                }
            });
            
            totalDuration += cookDuration;
            if (food.rest && food.rest.duration > 0) {
                planSteps.push({ title: `Repos: ${food.name}`, duration: food.rest.duration, action: food.rest.action, isRest: true });
                totalDuration += food.rest.duration;
            }

            if (appState.cookingMode === 'multiple' && index < appState.selectedFoods.length - 1) {
                const nextFood = foodDB[appState.selectedFoods[index + 1].category][appState.selectedFoods[index+1].key];
                const transitionDuration = 300; // 5 minutes buffer
                planSteps.push({
                    title: `Transition vers ${nextFood.name}`,
                    duration: transitionDuration,
                    action: `Pr√©parez la cuisson pour <strong>${nextFood.name}</strong>. V√©rifiez la temp√©rature du BBQ (${nextFood.targetTempBBQ}¬∞C) et ajustez les a√©rations si n√©cessaire.`,
                    isTransition: true
                });
                totalDuration += transitionDuration;
            }
        });
        
        let startTime, endTime;
        if (appState.flow === 'mealTime') {
            endTime = new Date(appState.mealTime);
            startTime = new Date(endTime.getTime() - totalDuration * 1000);
        } else {
            startTime = new Date();
            endTime = new Date(startTime.getTime() + totalDuration * 1000);
        }
        
        let cumulativeTime = startTime.getTime();
        planSteps.forEach(step => {
            step.startTime = new Date(cumulativeTime).toISOString();
            cumulativeTime += (step.duration || 0) * 1000;
            step.endTime = new Date(cumulativeTime).toISOString();
        });

        // Now that times are assigned, sort if needed (especially for multi-cook)
        planSteps.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        
        appState.plan = { startTime: startTime.toISOString(), endTime: endTime.toISOString(), totalDuration, steps: planSteps };
    }

    function displayPlanSummary() {
        const startTime = new Date(appState.plan.startTime);
        const endTime = new Date(appState.plan.endTime);
        const totalDuration = appState.plan.totalDuration;
        const steps = appState.plan.steps;
        
        const summaryDiv = document.getElementById('summary-content');
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        
        const weatherAlert = document.getElementById('weather-alert');
        if (appState.weather) {
            let alertMsg = '';
            if (appState.weather.windspeed > 25) {
                 alertMsg = `üå¨Ô∏è <strong>Alerte vent fort (${appState.weather.windspeed} km/h) !</strong> Attendez-vous √† une consommation de combustible plus √©lev√©e et surveillez la stabilit√© de la temp√©rature.`;
                 weatherAlert.className = 'my-4 p-4 rounded-lg bg-blue-100 border-l-4 border-blue-500 text-blue-700';
            } else if (appState.weather.temperature < 10) {
                alertMsg = `‚ùÑÔ∏è <strong>Il fait froid (${appState.weather.temperature}¬∞C) !</strong> Le temps de pr√©chauffage a √©t√© allong√© pour compenser.`;
                weatherAlert.className = 'my-4 p-4 rounded-lg bg-cyan-100 border-l-4 border-cyan-500 text-cyan-700';
            }
            if(alertMsg) {
                weatherAlert.innerHTML = alertMsg;
                weatherAlert.classList.remove('hidden');
            } else {
                 weatherAlert.classList.add('hidden');
            }
        } else {
            weatherAlert.classList.add('hidden');
        }


        let summaryHTML = `
            <div class="bg-gray-100 p-4 rounded-lg text-center">
                <p>Heure de d√©marrage : <strong class="text-2xl text-red-700">${formatTime(startTime)}</strong></p>
                <p>Repas pr√™t √† : <strong class="text-2xl text-green-600">${formatTime(endTime)}</strong></p>
                <p>Dur√©e totale estim√©e : <strong>${Math.floor(totalDuration/3600)}h ${Math.round((totalDuration%3600)/60)}min</strong></p>
            </div>
            <h3 class="font-bold mt-6 text-xl">Chronologie d√©taill√©e :</h3>
            <div class="border-l-2 border-gray-300 pl-4 space-y-4 mt-2">
        `;
        steps.forEach(step => {
            const durationText = step.isManualValidation ? "Action manuelle" : `~${Math.round(step.duration / 60)} min`;
            summaryHTML += `<div><p class="font-semibold">${formatTime(new Date(step.startTime))} - ${step.title}</p><p class="text-sm text-gray-600 ml-2">(${durationText}) - ${step.action}</p></div>`;
        });
        summaryHTML += `</div>`;
        summaryDiv.innerHTML = summaryHTML;
    }

    function startCooking() {
        document.getElementById('wizard').style.display = 'none';
        document.getElementById('cooking-timeline-section').classList.remove('hidden');
        appState.cookingState.currentStepIndex = -1; 
        saveSession();
        displayTimeline();
        displayWeatherInTimeline();
        
        document.getElementById('start-cooking-prompt').classList.remove('hidden');
        document.getElementById('timeline-container').style.opacity = '0.5';
        document.getElementById('history-toggle').classList.add('hidden');

        document.getElementById('currentStep').textContent = "En attente de d√©marrage";
        timerDisplay.textContent = "--:--";
        updateCookingTiles(-1);
    }
    
    function beginPreparation() {
        document.getElementById('start-cooking-prompt').classList.add('hidden');
        document.getElementById('timeline-container').style.opacity = '1';
        document.getElementById('history-toggle').classList.remove('hidden');
        advanceToNextStep();
    }
    
    // --- GESTION DE LA TIMELINE DE CUISSON ---
    function displayTimeline() {
        const container = document.getElementById('timeline-container');
        container.innerHTML = '';
        const formatTime = (date) => `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
        appState.plan.steps.forEach((step, index) => {
             const detailsHTML = `
                <div class="text-right text-xs mt-2 grid grid-cols-3 gap-2 text-gray-600">
                    ${step.zone ? `<div><strong>Zone:</strong><br>${step.zone}</div>` : ''}
                    ${step.vents ? `<div><strong>Vents:</strong><br>${step.vents}</div>` : ''}
                    ${step.grille ? `<div><strong>Grille:</strong><br>${step.grille}</div>` : ''}
                </div>
            `;

            container.innerHTML += `
                <div id="timeline-step-${index}" class="p-4 border rounded-lg bg-white transition-all duration-300">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-700"><span class="font-mono text-gray-500">${formatTime(new Date(step.startTime))}</span> - ${step.title}</p>
                            <div class="text-sm text-gray-600 ml-2 mt-1">${step.action || ''}</div>
                        </div>
                         <div class="status-icon text-gray-400 text-2xl">‚è≥</div>
                    </div>
                    ${step.isTransition ? '' : detailsHTML}
                    <div id="step-actions-${index}" class="mt-2 text-center"></div>
                </div>`;
        });
    }

    function advanceToNextStep() {
        clearInterval(intervalId);
        clearTimeout(stepTimeoutId);

        const newIndex = appState.cookingState.currentStepIndex + 1;
        appState.cookingState.currentStepIndex = newIndex;

        if (newIndex >= appState.plan.steps.length) {
            document.getElementById('currentStep').textContent = "CUISSON TERMIN√âE !";
            timerDisplay.textContent = "00:00";
            updateCookingTiles(-1);
            appState.cookingState.currentStepEndsAt = null;
            updateTimelineUI(); 
            saveToHistory(appState); // Save the completed cook
            localStorage.removeItem('activeBbqSession');
            return;
        }
        
        const currentStep = appState.plan.steps[newIndex];
        document.getElementById('currentStep').textContent = currentStep.title;
        
        const durationInMs = currentStep.duration * 1000;
        appState.cookingState.currentStepEndsAt = new Date(Date.now() + durationInMs).toISOString();
        
        updateTimelineUI(); 
        startStepTimer(newIndex);
        updateCookingTiles(newIndex);
        saveSession();
    }

    function startStepTimer(index) {
        const currentStep = appState.plan.steps[index];
        const actionsContainer = document.getElementById(`step-actions-${index}`);

        if (currentStep.isManualValidation) {
            timerDisplay.textContent = "MANUEL";
            if(actionsContainer) {
                actionsContainer.innerHTML = `<button onclick="advanceToNextStep()" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Pr√™t, Commencer la cuisson</button>`;
            }
            return;
        }

        const stepEndTime = new Date(appState.cookingState.currentStepEndsAt).getTime();
        
        const updateCountdown = () => {
            const remainingMs = Math.max(0, stepEndTime - Date.now());
            const remainingSeconds = Math.round(remainingMs / 1000);
            
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (remainingMs === 0) {
                clearInterval(intervalId);
                playAlarm();
                if(actionsContainer) {
                    actionsContainer.innerHTML = `<button onclick="advanceToNextStep()" class="action-button bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Valider & √âtape Suivante</button>`;
                }
            }
        };

        clearInterval(intervalId);
        updateCountdown();
        intervalId = setInterval(updateCountdown, 1000);

        if(actionsContainer) {
            actionsContainer.innerHTML = `<button onclick="advanceToNextStep()" class="text-xs bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-1 px-3 rounded-full">Passer √† l'√©tape suivante</button>`;
        }
    }

    function updateTimelineUI() {
        const currentIdx = appState.cookingState.currentStepIndex;
        const showHistory = document.getElementById('history-toggle').dataset.show === 'true';

        appState.plan.steps.forEach((step, index) => {
            const stepEl = document.getElementById(`timeline-step-${index}`);
            if (!stepEl) return;
            
            const iconEl = stepEl.querySelector('.status-icon');
            const actionsContainer = document.getElementById(`step-actions-${index}`);
            if(actionsContainer) actionsContainer.innerHTML = ''; 

            stepEl.classList.remove('opacity-50', 'bg-gray-100', 'bg-yellow-100', 'border-yellow-400', 'shadow-lg', 'hidden');

            if (index < currentIdx) { 
                stepEl.classList.add('opacity-50', 'bg-gray-100');
                iconEl.innerHTML = '‚úÖ';
                if (!showHistory) { 
                    stepEl.classList.add('hidden');
                }
            } else if (index === currentIdx) { 
                stepEl.classList.add('bg-yellow-100', 'border-yellow-400', 'shadow-lg');
                iconEl.innerHTML = '‚ñ∂Ô∏è';
                stepEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } else { 
                iconEl.innerHTML = '‚è≥';
            }
        });
    }
    
    function toggleHistory(button) {
        const show = button.dataset.show === 'true';
        button.dataset.show = !show;
        button.textContent = !show ? "Masquer l'historique" : "Afficher l'historique";
        updateTimelineUI();
    }

    function playAlarm() {
        try {
            const synth = new Tone.Synth().toDestination();
            const now = Tone.now();
            synth.triggerAttackRelease("C5", "8n", now);
            synth.triggerAttackRelease("G5", "8n", now + 0.2);
            synth.triggerAttackRelease("C5", "8n", now + 0.4);
        } catch(e) {
            console.warn("Could not play alarm sound.", e);
        }
    }

    function updateCookingTiles(index) {
        const bbqTempEl = document.getElementById('bbqTempTile');
        const internalTempEl = document.getElementById('internalTempTile');
        const ventsEl = document.getElementById('ventsTile');
        const grilleEl = document.getElementById('grilleTile');

        if (index < 0 || index >= appState.plan.steps.length) {
            bbqTempEl.textContent = '-';
            internalTempEl.textContent = '-';
            ventsEl.textContent = '-';
            grilleEl.textContent = '-';
            return;
        }

        let currentStep = appState.plan.steps[index];
        let associatedFood = null;

        if (currentStep.isSetup) {
            const firstFoodItem = appState.selectedFoods[0];
            if (firstFoodItem) {
                associatedFood = foodDB[firstFoodItem.category][firstFoodItem.key];
            }
        } else {
            for (const foodItem of appState.selectedFoods) {
                const foodData = foodDB[foodItem.category][foodItem.key];
                if (currentStep.title.startsWith(foodData.name)) {
                    associatedFood = foodData;
                    break;
                }
            }
        }

        bbqTempEl.textContent = associatedFood ? `${associatedFood.targetTempBBQ}¬∞C` : '-';
        internalTempEl.textContent = associatedFood ? `${associatedFood.targetTempInternal}¬∞C` : '-';
        ventsEl.textContent = currentStep.vents || '-';
        grilleEl.textContent = currentStep.grille || '-';
    }
    
    // --- FONCTIONS DES PANNEAUX LATERAUX ET MODALES ---
    const getHistory = () => JSON.parse(localStorage.getItem('bbqHistory') || '[]');
    const saveToHistory = (state) => {
        let history = getHistory();
        const cookName = state.selectedFoods.map(f => foodDB[f.category][f.key].name).join(' & ');
        const historyEntry = {
            id: Date.now(),
            name: cookName,
            date: new Date().toLocaleDateString('fr-FR'),
            state: state
        };
        history.unshift(historyEntry);
        if (history.length > 50) history.pop();
        localStorage.setItem('bbqHistory', JSON.stringify(history));
    };
    
    const getFavorites = () => JSON.parse(localStorage.getItem('bbqFavorites') || '[]');
    const saveFavorites = (favorites) => localStorage.setItem('bbqFavorites', JSON.stringify(favorites));

    function toggleFavorite(historyId, event) {
        event.stopPropagation();
        let favorites = getFavorites();
        const history = getHistory();
        const cookToAdd = history.find(item => item.id === historyId);

        if (!cookToAdd) return;
        
        const favIndex = favorites.findIndex(fav => fav.id === historyId);

        if (favIndex > -1) {
            favorites.splice(favIndex, 1);
        } else {
            favorites.unshift(cookToAdd);
        }
        
        saveFavorites(favorites);
        
        if (document.getElementById('tab-history').classList.contains('border-blue-600')) {
             populateHistory();
        } else {
             populateFavorites();
        }
    }


    function togglePanel(panelIdToOpen) { 
        allPanelIds.forEach(id => { if (id !== panelIdToOpen) { document.getElementById(id).classList.remove('visible'); } }); 
        const panel = document.getElementById(panelIdToOpen); 
        panel.classList.toggle('visible'); 
        if (panel.classList.contains('visible')) { 
            if (panelIdToOpen === 'saucesPanel') { loadAndDisplaySauces(); }
            if (panelIdToOpen === 'referenceGuide') { populateReferenceGuide(); }
            if (panelIdToOpen === 'notebookPanel') { showNotebookTab('favorites'); }
        } 
    }

    function showNotebookTab(tabName) {
        const favoritesTab = document.getElementById('tab-favorites');
        const historyTab = document.getElementById('tab-history');
        const favoritesContent = document.getElementById('notebookContentFavorites');
        const historyContent = document.getElementById('notebookContentHistory');

        if (tabName === 'favorites') {
            favoritesTab.classList.add('text-blue-600', 'border-blue-600');
            favoritesTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            historyTab.classList.remove('text-blue-600', 'border-blue-600');
            historyTab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            favoritesContent.classList.remove('hidden');
            historyContent.classList.add('hidden');
            populateFavorites();
        } else { // 'history'
            historyTab.classList.add('text-blue-600', 'border-blue-600');
            historyTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            favoritesTab.classList.remove('text-blue-600', 'border-blue-600');
            favoritesTab.classList.add('text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            historyContent.classList.remove('hidden');
            favoritesContent.classList.add('hidden');
            populateHistory();
        }
    }

    function populateFavorites() {
        const favorites = getFavorites();
        const container = document.getElementById('notebookContentFavorites');
        if (favorites.length === 0) {
            container.innerHTML = '<p class="p-4 text-center text-gray-500">Aucune cuisson en favoris.</p>';
            return;
        }
        container.innerHTML = favorites.map(item => `
            <div class="list-item flex justify-between items-center" onclick='rerunCook(${JSON.stringify(item.state)})'>
                 <div>
                    <span class="font-semibold">${item.name}</span>
                    <span class="text-xs text-gray-500 block">${item.date}</span>
                </div>
                <button onclick="toggleFavorite(${item.id}, event)" class="text-2xl">‚ù§Ô∏è</button>
            </div>`).join('');
    }

    function populateHistory() {
        const history = getHistory();
        const favorites = getFavorites();
        const container = document.getElementById('notebookContentHistory');
         if (history.length === 0) {
            container.innerHTML = '<p class="p-4 text-center text-gray-500">Aucun historique de cuisson.</p>';
            return;
        }
        container.innerHTML = history.map(item => {
            const isFavorite = favorites.some(fav => fav.id === item.id);
            return `
            <div class="list-item flex justify-between items-center" onclick='rerunCook(${JSON.stringify(item.state)})'>
                <div>
                    <span class="font-semibold">${item.name}</span>
                    <span class="text-xs text-gray-500 block">${item.date}</span>
                </div>
                <button onclick="toggleFavorite(${item.id}, event)" class="text-2xl">${isFavorite ? '‚ù§Ô∏è' : 'ü§ç'}</button>
            </div>`;
        }).join('');
    }
    
    function rerunCook(savedState) {
        resetApp();
        appState = savedState;
        // Regenerate plan with potentially new time if mealTime was set
        if(appState.flow === 'mealTime') {
            const now = new Date();
            const defaultMealTime = new Date(now.getTime() + 4 * 3600 * 1000);
            document.getElementById('mealTimeInput').value = `${String(defaultMealTime.getHours()).padStart(2,'0')}:${String(defaultMealTime.getMinutes()).padStart(2,'0')}`;
            showScreen('screen-meal-time');
        } else {
             generateCookingPlan();
            displayPlanSummary();
            showScreen('screen-planning-summary');
        }
        togglePanel('notebookPanel');
    }

    async function callGemini(prompt, isJson = false) {
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        if (isJson) { payload.generationConfig = { responseMimeType: "application/json" }; }
        const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!response.ok) { console.error("API Error:", await response.json()); throw new Error("API Call Failed"); }
        const result = await response.json();
        return result.candidates[0].content.parts[0].text;
    }

    async function loadAndDisplaySauces() {
        const container = document.getElementById('saucesPanelContent');
        const cachedSauces = localStorage.getItem('saucesDB');
        if (cachedSauces) {
            window.saucesDB = JSON.parse(cachedSauces);
            displayPrepTypeSelection();
            return;
        }
        
        container.innerHTML = '<p class="text-center p-4">Chargement des recettes de base...</p>';
        const prompt = `Agis comme un chef sp√©cialis√© en barbecue. Cr√©e un guide de pr√©parations. Retourne UNIQUEMENT un objet JSON valide. La structure doit avoir 3 cl√©s principales: "Sauce", "Marinade", "RUB". Pour chaque cl√©, la valeur est un objet o√π chaque cl√© est un type de viande (ex: "Boeuf", "Porc", "Volaille", "Poisson"). La valeur pour chaque type de viande doit √™tre un tableau d'au moins 2 objets recette. Chaque objet recette doit avoir "name", "ingredients" (tableau de strings), et "preparation" (string). Toutes les recettes doivent √™tre sans gluten. Ne renvoie rien d'autre que l'objet JSON.`;
        try {
            const result = await callGemini(prompt, true);
            window.saucesDB = JSON.parse(result);
            localStorage.setItem('saucesDB', result); // Cache the result
            displayPrepTypeSelection();
        } catch (error) {
            container.innerHTML = `<p class="text-red-500 p-4">Erreur de chargement des recettes de base.</p>`;
            return;
        }
    }

    function displayPrepTypeSelection() {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = 'Choisir une pr√©paration';
        document.getElementById('saucesBackButton').classList.add('hidden');
        container.innerHTML = `
            <div class="list-item font-semibold" onclick="showMeatCategories('Sauce')">Sauces</div>
            <div class="list-item font-semibold" onclick="showMeatCategories('Marinade')">Marinades</div>
            <div class="list-item font-semibold" onclick="showMeatCategories('RUB')">RUBs (√âpices s√®ches)</div>
        `;
    }

    function showMeatCategories(prepType) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = `Choisir une viande pour : ${prepType}`;
        document.getElementById('saucesBackButton').classList.remove('hidden');
        container.innerHTML = '';
        Object.keys(window.saucesDB[prepType]).forEach(meatType => {
            container.innerHTML += `<div class="list-item font-semibold" onclick="displaySauceList('${prepType}', '${meatType}')">${meatType}</div>`;
        });
    }

    function displaySauceList(prepType, meatType) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = `Recettes pour : ${meatType}`;
        container.innerHTML = '';
        window.saucesDB[prepType][meatType].forEach(recipe => {
            container.innerHTML += `<div class="list-item" onclick='displaySauceRecipe(${JSON.stringify(recipe)})'>${recipe.name}</div>`;
        });
    }

    function displaySauceRecipe(recipe) {
        const container = document.getElementById('saucesPanelContent');
        document.getElementById('saucesTitle').textContent = recipe.name;
        container.innerHTML = `
            <h3 class="text-lg font-bold text-gray-800 mt-2 mb-2">Ingr√©dients</h3>
            <ul class="list-disc list-inside text-gray-700 space-y-1">${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>
            <h3 class="text-lg font-bold text-gray-800 mt-4 mb-2">Pr√©paration</h3>
            <p class="text-gray-700 whitespace-pre-line">${recipe.preparation}</p>
        `;
    }

    function goBackSauces() { displayPrepTypeSelection(); }

    function triggerGetRecipes(recipe) {
        currentRecipe = recipe;
        const modal = document.getElementById('recipeModal');
        const modalBox = document.getElementById('recipeModalBox');
        const title = document.getElementById('recipeModalTitle');
        const preferenceInput = document.getElementById('recipePreferenceInput');
        const content = document.getElementById('recipeModalContent');
        const actions = document.getElementById('recipeModalActions');

        title.textContent = `Recette pour ${currentRecipe.itemName}`;
        preferenceInput.value = '';
        content.innerHTML = '';
        actions.innerHTML = `<button onclick="getRecipes()" class="action-button bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">G√©n√©rer la recette</button>`;
        
        modal.classList.remove('hidden');
        setTimeout(() => modalBox.classList.remove('scale-95', 'opacity-0'), 10);
    }
    
    async function getRecipes() {
        const content = document.getElementById('recipeModalContent');
        const preference = document.getElementById('recipePreferenceInput').value;
        content.innerHTML = '<p>Gemini r√©fl√©chit √† une recette et √† son plan de cuisson...</p>';

        const userPreference = preference ? `qui inclut sp√©cifiquement la pr√©f√©rence suivante : "${preference}"` : '';
        
        const prompt = `Pour une recette de "${currentRecipe.itemName}" ${userPreference}, g√©n√®re un objet JSON unique. Cet objet doit contenir deux cl√©s: "displayText" et "cookingPlan".
        1. "displayText": Une cha√Æne de caract√®res format√©e en Markdown simple contenant une recette (titre, ingr√©dients, pr√©paration).
        2. "cookingPlan": Un objet JSON structur√© pour une app de BBQ avec les cl√©s: "name" (string), "type" (string, ex: 'boeuf'), "rub_friendly": true, "duration" (number, secondes), "targetTempBBQ" (number, Celsius), "targetTempInternal" (number, Celsius), "methods" (tableau avec un objet: {type: 'grill' ou 'smoke', steps: [{name, duration, action, zone, grille, vents}]}), et "rest" ({duration}).
        Toute la recette doit √™tre sans gluten. Ne renvoie que l'objet JSON.`;
        try {
            const jsonString = await callGemini(prompt, true);
            const recipeData = JSON.parse(jsonString);

            currentRecipe.text = recipeData.displayText;
            currentGeneratedPlan = recipeData.cookingPlan;

            if (currentRecipe.id.toString().length < 10) currentRecipe.id = Date.now();
            //saveToHistory(currentRecipe); // This was for individual recipes, now we save the full cook
            displayRecipe();
        } catch (error) { 
            console.error("Recipe generation error:", error);
            content.innerHTML = `<p class="text-red-500">D√©sol√©, une erreur est survenue lors de la g√©n√©ration de la recette.</p>`; 
        }
    }

    function displayRecipe() {
        const content = document.getElementById('recipeModalContent');
        const actions = document.getElementById('recipeModalActions');
        let html = currentRecipe.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/### (.*)/g, '<h3 class="text-lg font-semibold mt-4">$1</h3>').replace(/## (.*)/g, '<h2 class="text-xl font-bold mt-6 border-b pb-2 mb-2">$1</h2>').replace(/\n- /g, '\n<li>').replace(/\n/g, '<br>');
        html = html.replace(/<li>(.*?)<br>/g, '<li>$1</li>').replace(/(<li>.*?<\/li>)/g, '<ul>$1</ul>').replace(/<\/ul><ul>/g, '');
        content.innerHTML = html;
        
        // This favorite logic is for individual recipes, not full cooks. Can be simplified or removed if not needed.
        // const isFavorite = getFavorites().some(fav => fav.id === currentRecipe.id); 
        actions.innerHTML = `
            <div>
                <button onclick="getRecipes()" class="action-button bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">R√©g√©n√©rer</button>
            </div>
            <div class="flex gap-2">
                <button onclick="useGeneratedPlan()" class="action-button bg-green-600 text-white font-bold py-2 px-4 rounded-lg">Cuisiner</button>
            </div>
        `;
    }

    function useGeneratedPlan() {
        if (!currentGeneratedPlan) {
            showAlert("Erreur", "Aucun plan de cuisson n'a √©t√© g√©n√©r√©.");
            return;
        }
        closeRecipeModal();
        const customKey = `custom_${Date.now()}`;
        foodDB["Recettes Personnalis√©es"][customKey] = currentGeneratedPlan;
        
        showScreen('screen-food-selection');
        populateAllFoodItems(appState.cookingMode === 'single' ? 1 : 2);
        
        appState.selectedFoods.push({ category: "Recettes Personnalis√©es", key: customKey });
        updateSelectedFoodsSummary();

        // Check the newly added item
        setTimeout(() => {
            const newFoodInput = document.querySelector(`input[value="Recettes Personnalis√©es:${customKey}"]`);
            if (newFoodInput) {
                newFoodInput.checked = true;
            }
        }, 0);
    }
    
    // --- FONCTIONS UTILITAIRES ET INITIALISATION ---
    function resetApp() {
        clearInterval(intervalId); 
        clearTimeout(stepTimeoutId);
        localStorage.removeItem('activeBbqSession');
        resetAppState();
        document.getElementById('wizard').style.display = 'block';
        document.getElementById('cooking-timeline-section').classList.add('hidden');
        showScreen('screen-home');
    }
    
    function checkPassword() {
        if (document.getElementById('passwordInput').value === ACCESS_CODE) {
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        } else {
            document.getElementById('passwordError').classList.remove('hidden');
        }
    }

    function showAlert(title, message) { document.getElementById('alertModalTitle').textContent = title; document.getElementById('alertModalMessage').textContent = message; const modal = document.getElementById('alertModal'); const modalBox = document.getElementById('alertModalBox'); modal.classList.remove('hidden'); setTimeout(() => modalBox.classList.remove('scale-95', 'opacity-0'), 10); }
    function closeAlertModal() { const modalBox = document.getElementById('alertModalBox'); modalBox.classList.add('scale-95', 'opacity-0'); setTimeout(() => document.getElementById('alertModal').classList.add('hidden'), 200); }
    function closeRecipeModal() { const modalBox = document.getElementById('recipeModalBox'); modalBox.classList.add('scale-95', 'opacity-0'); setTimeout(() => document.getElementById('recipeModal').classList.add('hidden'), 200); }
    
    // --- NOUVELLES FONCTIONNALIT√âS V2 ---
    async function getWeather() {
        if (!navigator.geolocation) {
            console.warn("Geolocation is not supported by your browser. Weather feature will be skipped.");
            return;
        }
        try {
            const position = await new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => reject(new Error("Geolocation timeout")), 10000);
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        clearTimeout(timeoutId);
                        resolve(pos);
                    }, 
                    (err) => {
                        clearTimeout(timeoutId);
                        reject(err);
                    }
                );
            });
            const { latitude, longitude } = position.coords;
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,wind_speed_10m`);
            if (!response.ok) throw new Error(`Weather API failed with status ${response.status}`);
            const data = await response.json();
            appState.weather = {
                temperature: data.current.temperature_2m,
                windspeed: data.current.wind_speed_10m
            };
        } catch (error) {
            console.warn(`Could not fetch weather data: ${error.message}. The weather feature will be skipped.`);
            appState.weather = null;
        }
    }
    
    function displayWeatherInTimeline() {
        const container = document.getElementById('live-weather-display');
        if (appState.weather) {
            container.innerHTML = `
                <span>‚òÄÔ∏è ${appState.weather.temperature}¬∞C</span>
                <span>|</span>
                <span>üí® ${appState.weather.windspeed} km/h</span>
            `;
        } else {
            container.innerHTML = `<span class="text-xs">M√©t√©o non disponible (g√©olocalisation refus√©e)</span>`;
        }
    }

    function saveSession() {
        localStorage.setItem('activeBbqSession', JSON.stringify(appState));
    }

    function resumeSessionIfExists() {
        const savedSession = localStorage.getItem('activeBbqSession');
        if (savedSession) {
            appState = JSON.parse(savedSession);
            
            if (appState.cookingState.currentStepIndex < 0 || !appState.plan || appState.cookingState.currentStepIndex >= appState.plan.steps.length) {
                localStorage.removeItem('activeBbqSession');
                return;
            }

            document.getElementById('wizard').style.display = 'none';
            document.getElementById('cooking-timeline-section').classList.remove('hidden');
            document.getElementById('passwordModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            displayTimeline();
            displayWeatherInTimeline();
            
            if (appState.cookingState.currentStepIndex < 0) {
                // Session was prepared but not started, show the start button
                document.getElementById('start-cooking-prompt').classList.remove('hidden');
                document.getElementById('timeline-container').style.opacity = '0.5';
                document.getElementById('history-toggle').classList.add('hidden');
                document.getElementById('currentStep').textContent = "En attente de d√©marrage";
                timerDisplay.textContent = "--:--";
                updateCookingTiles(-1);
            } else {
                // Session was in progress, resume it
                const currentIdx = appState.cookingState.currentStepIndex;
                const currentStep = appState.plan.steps[currentIdx];
                document.getElementById('currentStep').textContent = currentStep.title;
                
                updateTimelineUI();
                updateCookingTiles(currentIdx);
                startStepTimer(currentIdx);
            }
        }
    }

    function showTroubleshootingModal() {
        const modal = document.getElementById('troubleshootingModal');
        const modalBox = document.getElementById('troubleshootingModalBox');
        modal.classList.remove('hidden');
        setTimeout(() => modalBox.classList.remove('scale-95', 'opacity-0'), 10);
        showTroubleshootingHelp('main');
    }

    function closeTroubleshootingModal() {
        const modalBox = document.getElementById('troubleshootingModalBox');
        modalBox.classList.add('scale-95', 'opacity-0');
        setTimeout(() => document.getElementById('troubleshootingModal').classList.add('hidden'), 200);
    }
    
    function showTroubleshootingHelp(topic) {
        const content = document.getElementById('troubleshootingContent');
        let html = `<button onclick="showTroubleshootingHelp('main')" class="text-blue-600 mb-4">&larr; Retour</button>`;

        switch(topic) {
            case 'temp':
                html += `
                    <h2>üå°Ô∏è Temp√©rature Instable</h2>
                    <h3>La temp√©rature est trop basse :</h3>
                    <ul>
                        <li><strong>Ouvrez les a√©rations :</strong> Plus d'air = plus de chaleur. Ouvrez un peu plus l'a√©ration du bas (laissez celle du haut ouverte).</li>
                        <li><strong>V√©rifiez les cendres :</strong> Trop de cendres peuvent √©touffer les braises. Utilisez le syst√®me de nettoyage pour les √©vacuer.</li>
                        <li><strong>Ajoutez du combustible :</strong> Si les braises sont petites, ajoutez 5-6 briquettes pr√©-allum√©es.</li>
                    </ul>
                    <h3>La temp√©rature est trop haute :</h3>
                    <ul>
                        <li><strong>Fermez les a√©rations :</strong> Moins d'air = moins de chaleur. R√©duisez l'ouverture de l'a√©ration du bas et/ou du haut. Ne fermez jamais compl√®tement.</li>
                        <li><strong>Attention au couvercle :</strong> Gardez le couvercle ferm√© au maximum. Chaque ouverture fait grimper la temp√©rature.</li>
                    </ul>`;
                break;
            case 'stall':
                 html += `
                    <h2>üßê La Cuisson Stagne (le "Stall")</h2>
                    <p>Le "stall" est un ph√©nom√®ne normal, surtout pour les grosses pi√®ces comme le <strong>Brisket</strong> ou le <strong>Pulled Pork</strong>. La temp√©rature interne de la viande stagne (souvent entre 65¬∞C et 75¬∞C) pendant des heures. C'est d√ª √† l'√©vaporation de l'humidit√© en surface qui refroidit la viande.</p>
                    <h3>Que faire ?</h3>
                    <ul>
                        <li><strong>√ätre patient :</strong> Le stall finira par passer. C'est la m√©thode "puriste".</li>
                        <li><strong>Le "Texas Crutch" (L'astuce) :</strong> Emballez fermement la viande dans du papier boucher (pour conserver la cro√ªte) ou du papier aluminium. Cela bloque l'√©vaporation et vous fera passer le stall beaucoup plus vite. Reposez la viande sur la grille et continuez la cuisson.</li>
                    </ul>`;
                break;
            case 'flareup':
                 html += `
                    <h2>üî• Flammes Soudaines (Flare-up)</h2>
                    <p>C'est caus√© par la graisse qui tombe sur les braises. C'est mauvais car cela carbonise la viande et donne un go√ªt amer.</p>
                    <h3>Actions imm√©diates :</h3>
                    <ul>
                        <li><strong>D√©placez la viande :</strong> Mettez imm√©diatement la viande en zone de cuisson <strong>indirecte</strong> (loin des braises).</li>
                        <li><strong>√âtalez les braises :</strong> Si vous avez trop de braises concentr√©es, √©talez-les un peu.</li>
                        <li><strong>En dernier recours :</strong> Fermez le couvercle et les a√©rations pendant 30 secondes pour √©touffer les flammes par manque d'oxyg√®ne.</li>
                    </ul>`;
                break;
            default: // main menu
                 html = `
                    <p>Quel est votre probl√®me ?</p>
                    <div class="space-y-3 mt-4">
                        <button onclick="showTroubleshootingHelp('temp')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üå°Ô∏è Ma temp√©rature est instable (trop haute / trop basse)</button>
                        <button onclick="showTroubleshootingHelp('stall')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üßê Ma cuisson stagne (le fameux "stall")</button>
                        <button onclick="showTroubleshootingHelp('flareup')" class="w-full text-left p-3 bg-gray-100 hover:bg-gray-200 rounded-lg">üî• J'ai des flammes soudaines (flare-up)</button>
                    </div>`;
        }
        content.innerHTML = html;
    }

    async function populateReferenceGuide() {
        const container = document.getElementById('referenceGuideContent');
        const cachedGuide = localStorage.getItem('referenceGuideContent');

        if(cachedGuide) {
            container.innerHTML = cachedGuide;
            return;
        }
        
        container.innerHTML = `<p class="text-center p-4">Gemini pr√©pare votre aide-m√©moire...</p>`;
        const prompt = `Agis comme un expert du barbecue Napol√©on PRO22K-LEG-3. Cr√©e un aide-m√©moire concis en Markdown simple. Inclus 3 sections : 
        1. "## Accords Bois & Viandes" (un tableau simple avec 2 colonnes : Viande, Bois recommand√©s).
        2. "## Temp√©ratures Internes" (un tableau simple avec 3 colonnes : Viande, Cuisson, T¬∞C Cible). Inclure Boeuf, Porc, Volaille.
        3. "## R√©glages des A√©rations du Kettle" (une liste √† puces expliquant l'impact des a√©rations du bas et du haut).
        Ne renvoie que le Markdown.`;

        try {
            let markdown = await callGemini(prompt);
            let html = markdown
                .replace(/^## (.*$)/g, '<h2>$1</h2>')
                .replace(/^### (.*$)/g, '<h3>$1</h3>')
                .replace(/\n\s*-\s/g, '\n<li>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\|(.+)\|(.+)\|(.+)\|/g, "<tr><td class='border px-2 py-1'>$1</td><td class='border px-2 py-1'>$2</td><td class='border px-2 py-1'>$3</td></tr>")
                .replace(/\|(.+)\|(.+)\|/g, "<tr><td class='border px-2 py-1'>$1</td><td class='border px-2 py-1'>$2</td></tr>")
                .replace(/<tr><td class='border px-2 py-1'>---.+<\/tr>/g, "") // remove header separator
                .replace(/(<tr>.*<\/tr>)/g, "<table class='w-full text-sm my-2'><tbody>$1</tbody></table>")
                .replace(/<\/table>(\n*)<table/g, '</table><table')
                .replace(/(<li>.*)/g, "<ul>$1</ul>")
                .replace(/<\/ul>\n<ul>/g, '');

            container.innerHTML = html;
            localStorage.setItem('referenceGuideContent', html);

        } catch(e) {
            container.innerHTML = `<p class="text-red-500">Erreur de chargement du guide.</p>`;
            console.error(e);
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('passwordInput').focus();
        document.getElementById('passwordInput').addEventListener('keyup', (e) => e.key === "Enter" && checkPassword());
        resetApp();
        resumeSessionIfExists();
    });

    </script>
</body>
</html>

